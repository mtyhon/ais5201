

<!DOCTYPE html>


<html data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Grids of Stellar Models Part 2: Interpolation &#8212; AIS 5201: AI In Astrophysics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapter3/tabular-2';</script>
    <link rel="canonical" href="https://USER.github.io/REPO/chapter3/tabular-2.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Catalogue Data Part 1: Mixed Data Types" href="tabular-3.html" />
    <link rel="prev" title="Grids of Stellar Models Part 1: Stellar Parameter Regression" href="tabular-1.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">AIS 5201: AI In Astrophysics</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction to AIS 5201
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter1/section_intro.html">Time-domain Data</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/fitting_power_spectrum_1.html">Fitting Red Giant Oscillations Part 1: <em>Traditional Optimization</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/fitting_power_spectrum_2.html">Fitting Red Giant Oscillations Part 2: <em>Flows &amp; Simulation-Based Inference</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/ps_statistics.html"><em>Power Spectrum Statistics</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/eb-morphology_1.html">Eclipse Morphology Part 1: <em>Exploring and Preparing Data</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/eb-morphology_2.html">Eclipse Morphology Part 2: <em>Low-Dimensional Representations</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/eb-morphology_3.html">Eclipse Morphology Part 3: <em>Latent Spaces and Visualizing Them</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/eb-morphology_4.html">Eclipse Morphology Part 4: <em>The Variational Autoencoder</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/transit-1.html">Planetary Transits Part 1: <em>Observing Transits</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/transit-2.html">Planetary Transits Part 2: <em>Classifying Transits</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/transit-3.html">Planetary Transits Part 3: <em>Fitting a Transit Profile</em></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter2/section_intro.html">Spectra</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/sed-1.html">Spectral Energy Distribution (SED) Part 1: <em>Observing SEDs</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/sed-2.html">Spectral Energy Distribution (SED) Part 2: <em>Fitting SEDs</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/sed-3.html">Spectral Energy Distribution (SED) Part 3: <em>Bayesian Evidence and Model Selection</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-1.html">Stellar Spectra Part 1: <em>Observing Detailed Spectral Features</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-2.html">Stellar Spectra Part 2: <em>The Cannon</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-3.html">Stellar Spectra Part 3: <em>The Payne</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-4.html">Stellar Spectra Part 4: <em>Detecting Stellar Activity Indicators</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-5.html">Stellar Spectra Part 5: <em>Domain Transfer</em></a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="section_intro.html">Tabular Data</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tabular-1.html">Grids of Stellar Models Part 1: <em>Stellar Parameter Regression</em></a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Grids of Stellar Models Part 2: <em>Interpolation</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="tabular-3.html">Catalogue Data Part 1: <em>Mixed Data Types</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="tabular-4.html">Catalogue Data Part 2: <em>Finding Clusters and Overdensities</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="tabular-5.html"><em>The Physics Informed Neural Network</em></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter4/section_intro.html">Images</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter4/images-1.html">Images Part 1: <em>Galaxy Merger Classification</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter4/images-2.html">Images Part 2: <em>Galaxy Morphology Classification</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter4/images-3.html">Images Part 3: <em>Self-Supervised Learning</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter4/images-4.html">Images Part 4: <em>Upscaling the Cosmic Web</em></a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/executablebooks/jupyter-book/blob/master/docs/chapter3/tabular-2.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/edit/master/docs/chapter3/tabular-2.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fchapter3/tabular-2.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/chapter3/tabular-2.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Grids of Stellar Models Part 2: Interpolation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#isochrones-and-evolutionary-phases">Isochrones and Evolutionary Phases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-parameters-mathbf-y">Input Parameters, <span class="math notranslate nohighlight">\(\mathbf{y}\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-observable-parameters-mathbf-x">Output Observable Parameters, <span class="math notranslate nohighlight">\(\mathbf{x}\)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-curse-of-dimensionality">The Curse of Dimensionality</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-discrepancy-metric">The Discrepancy Metric</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-interpolation-using-eeps">Linear Interpolation using EEPs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#beyond-linear-interpolation-emulation">Beyond Linear Interpolation: Emulation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#emulating-stellar-grids-with-neural-networks">Emulating Stellar Grids with Neural Networks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#normalizing-flows-as-a-grid-emulator">Normalizing Flows as a Grid Emulator</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-emulated-distribution-from-the-trained-flow">Visualizing the Emulated Distribution from the Trained Flow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scenario-1-emulating-an-individual-track">Scenario 1: Emulating an individual track</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scenario-2-emulating-a-continuum-of-tracks">Scenario 2: Emulating a continuum of tracks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flow-based-stellar-parameter-inference-sampling-importance-resampling">Flow-based Stellar Parameter Inference: Sampling-Importance Resampling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-importance-resampling-sir">Sampling/Importance Resampling (SIR)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-visual-example-of-sampling-importance-resampling-sir">A Visual Example of Sampling/Importance Resampling (SIR)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#see-also">See Also:</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="grids-of-stellar-models-part-2-interpolation">
<span id="content-references-tabular-part2"></span><h1>Grids of Stellar Models Part 2: <em>Interpolation</em><a class="headerlink" href="#grids-of-stellar-models-part-2-interpolation" title="Permalink to this headline">#</a></h1>
<p><em><strong>Author: Marc Hon</strong></em></p>
<p>In <a class="reference internal" href="tabular-1.html#content-references-tabular-part1"><span class="std std-ref">Grids of Stellar Models Part 1: Stellar Parameter Regression</span></a>, we were introduced to grids of evolutionary tracks and isochrones, which are generated from a combination of initial conditions, such as mass and metallicity.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">corner</span>
<span class="kn">import</span> <span class="nn">scienceplots</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mticker</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>

<span class="kn">from</span> <span class="nn">matplotlib.cm</span> <span class="kn">import</span> <span class="n">ScalarMappable</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">coordinates</span> <span class="k">as</span> <span class="n">coords</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">truncnorm</span><span class="p">,</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">inset_axes</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;science&#39;</span><span class="p">);</span> <span class="n">fs</span><span class="o">=</span><span class="mi">15</span>

<span class="n">data_folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;ml_astro&#39;</span> <span class="o">/</span> <span class="s1">&#39;chapter3&#39;</span> <span class="o">/</span> <span class="s1">&#39;data&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="isochrones-and-evolutionary-phases">
<h2>Isochrones and Evolutionary Phases<a class="headerlink" href="#isochrones-and-evolutionary-phases" title="Permalink to this headline">#</a></h2>
<p>Here, we will examine a grid of models varied in initial mass and initial metallicity along the red giant branch phase of evolution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rg_grid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data_folder_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/RG_grid.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_met&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">])</span>
<span class="n">rg_grid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>teff</th>
      <th>rad</th>
      <th>age</th>
    </tr>
    <tr>
      <th>initial_mass</th>
      <th>initial_met</th>
      <th>step</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1.3</th>
      <th rowspan="5" valign="top">-1.25</th>
      <th>453</th>
      <td>3.941125</td>
      <td>0.237314</td>
      <td>2.205380</td>
    </tr>
    <tr>
      <th>454</th>
      <td>3.937966</td>
      <td>0.247855</td>
      <td>2.217799</td>
    </tr>
    <tr>
      <th>455</th>
      <td>3.934595</td>
      <td>0.258536</td>
      <td>2.228859</td>
    </tr>
    <tr>
      <th>456</th>
      <td>3.931033</td>
      <td>0.269315</td>
      <td>2.238671</td>
    </tr>
    <tr>
      <th>457</th>
      <td>3.927306</td>
      <td>0.280156</td>
      <td>2.247375</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">2.1</th>
      <th rowspan="5" valign="top">0.50</th>
      <th>701</th>
      <td>3.638026</td>
      <td>1.217787</td>
      <td>1.518331</td>
    </tr>
    <tr>
      <th>702</th>
      <td>3.636780</td>
      <td>1.227291</td>
      <td>1.518392</td>
    </tr>
    <tr>
      <th>703</th>
      <td>3.635558</td>
      <td>1.236729</td>
      <td>1.518443</td>
    </tr>
    <tr>
      <th>704</th>
      <td>3.634333</td>
      <td>1.246124</td>
      <td>1.518488</td>
    </tr>
    <tr>
      <th>705</th>
      <td>3.633113</td>
      <td>1.255467</td>
      <td>1.518526</td>
    </tr>
  </tbody>
</table>
<p>81570 rows × 3 columns</p>
</div></div></div>
</div>
<section id="input-parameters-mathbf-y">
<h3>Input Parameters, <span class="math notranslate nohighlight">\(\mathbf{y}\)</span><a class="headerlink" href="#input-parameters-mathbf-y" title="Permalink to this headline">#</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Column</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">initial_mass</span></code></p></td>
<td><p>Initial stellar mass (in solar masses, <span class="math notranslate nohighlight">\(M_\odot\)</span>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">initial_met</span></code></p></td>
<td><p>Initial metallicity, [Fe/H]</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">step</span></code></p></td>
<td><p>Equivalent Evolutionary Phase (EEP) of the stellar model along the evolutionary track/isochrone</p></td>
</tr>
</tbody>
</table>
</section>
<section id="output-observable-parameters-mathbf-x">
<h3>Output Observable Parameters, <span class="math notranslate nohighlight">\(\mathbf{x}\)</span><a class="headerlink" href="#output-observable-parameters-mathbf-x" title="Permalink to this headline">#</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Column</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">teff</span></code></p></td>
<td><p>Effective temperature, <span class="math notranslate nohighlight">\(T_{\mathrm{eff}}\)</span> (K)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">rad</span></code></p></td>
<td><p>Stellar radius, <span class="math notranslate nohighlight">\(R_{\odot}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">age</span></code></p></td>
<td><p>Stellar age (Gyr)</p></td>
</tr>
</tbody>
</table>
<div class="note admonition">
<p class="admonition-title">What is an Equivalent Evolutionary Phase (EEP)?</p>
<p>Stellar models evolve at <em>non-uniform rates</em> across different phases (e.g., slowly on the main sequence, quickly through the giant branch). This makes comparing different stars or interpolating between models difficult, especially when age is used as the interpolation parameter. For instance, while an age of 1 Gyr may correspond to a <strong>low-mass star still burning hydrogen on the main sequence</strong>, it also corresponds to a <strong>high-mass star burning helium as a red giant</strong>.</p>
<p>To solve this, <a class="reference external" href="https://iopscience.iop.org/article/10.3847/0067-0049/222/1/8">Dotter et al. (2016)</a> define <strong>Equivalent Evolutionary Phases (EEPs)</strong> — standardized markers that divide a stellar track into physically meaningful and uniformly spaced <em>phases of evolution</em> rather than time steps. EEPs align similar physical stages across stars of different masses and metallicities, and have two distinctions:</p>
<ul class="simple">
<li><p><strong>Primary EEPs</strong> represent distinct, physically motivated phases along a star’s lifetime.</p></li>
<li><p><strong>Secondary EEPs</strong> provide a uniform spacing between the primary EEPs in each track.</p></li>
</ul>
<figure class="align-default" id="eep">
<a class="reference internal image-reference" href="../_images/eep.png"><img alt="../_images/eep.png" src="../_images/eep.png" style="width: 800px; height: 300px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 31 </span><span class="caption-text">Evolutionary tracks and EEPs adapted from <a class="reference external" href="https://iopscience.iop.org/article/10.3847/0067-0049/222/1/8">Dotter et al. (2016)</a>. (Left) An evolutionary track of a <span class="math notranslate nohighlight">\(1_M{\odot}\)</span> star, with main evolutionary phases (EEPs) marked with larger dots and annotated. The secondary EEPs are indicated by the smaller dots. (Right) This distribution of primary and secondary EEPs for three stellar evolution tracks with initial masses of <span class="math notranslate nohighlight">\(0.95M_{\odot}, 1M_{\odot},\)</span> and <span class="math notranslate nohighlight">\(1.05M_{\odot}\)</span>. <strong>EEPs enable meaningful interpolation across different evolutionary tracks, even when those tracks evolve at different rates in time.</strong></span><a class="headerlink" href="#eep" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div>
<p>To be useful in inferring stellar parameters, these grids should cover a range of values across the input parameter space. The central question here is:</p>
<hr class="docutils" />
<p><strong>How should the input parameter space be sampled to provide the best coverage?</strong></p>
<hr class="docutils" />
<p>The most convenient (and common) approach is to perform uniform sampling:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_uniform_grid</span><span class="p">(</span><span class="n">m_</span><span class="p">,</span> <span class="n">f_</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
               <span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;initial_met&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">unique_mass_met</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                 <span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;initial_met&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">unique_mass_met</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">m_</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">85</span><span class="p">)</span>

            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">m_</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">)][</span><span class="s1">&#39;teff&#39;</span><span class="p">],</span>
                 <span class="mi">10</span><span class="o">**</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">m_</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">)][</span><span class="s1">&#39;rad&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f_</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f_</span><span class="p">,</span> <span class="n">s</span><span class="p">)][</span><span class="s1">&#39;teff&#39;</span><span class="p">],</span>
                 <span class="mi">10</span><span class="o">**</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f_</span><span class="p">,</span> <span class="n">s</span><span class="p">)][</span><span class="s1">&#39;rad&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">5500</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$T_{</span><span class="se">\\</span><span class="s1">mathrm</span><span class="si">{eff}</span><span class="s1">}$ (K)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Radius ($R_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Initial Mass ($M_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Initial Metallicity (dex)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Fixed Initial Mass (</span><span class="si">%.1f</span><span class="s1"> $M_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">m_</span><span class="p">))</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Fixed Initial Metallicity (</span><span class="si">%.2f</span><span class="s1"> dex)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">f_</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_mass</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">init_metallicity</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">plot_uniform_grid</span><span class="p">(</span><span class="n">init_mass</span><span class="p">,</span> <span class="n">init_metallicity</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a939ca3be2b228281afdb187e016384513e25ca663d13095701b9d12a28e43cd.png" src="../_images/a939ca3be2b228281afdb187e016384513e25ca663d13095701b9d12a28e43cd.png" />
</div>
</div>
<p>The above left shows a grid of models regularly spaced in initial mass and metallicity. The models in <span style="color: magenta">pink</span> indicate tracks varied in initial metallicity at a fixed initial mass, while the models in <span style="color: orange">orange</span> indicate tracks varied in initial mass at a fixed initial metallicity.</p>
<div class="note admonition">
<p class="admonition-title">Variation of evolutionary tracks</p>
<p>In the code block above, <code class="docutils literal notranslate"><span class="pre">init_mass</span></code> and <code class="docutils literal notranslate"><span class="pre">init_metallicity</span></code> control which values of initial mass and metallicity are highlighted from the uniform grid, respectively.</p>
<ul class="simple">
<li><p>Vary both of these parameters, one at a time, within the permissible range of the grid of models. What happens to the tracks, and in which direction do they move?</p></li>
<li><p>Which parameter (<code class="docutils literal notranslate"><span class="pre">init_mass</span></code> or <code class="docutils literal notranslate"><span class="pre">init_metallicity</span></code>) has the larger influence on the maximum extent of stellar models in radius and in modifying the surface temperature of the star?</p></li>
</ul>
</div>
</section>
</section>
<section id="the-curse-of-dimensionality">
<h2>The Curse of Dimensionality<a class="headerlink" href="#the-curse-of-dimensionality" title="Permalink to this headline">#</a></h2>
<p>Despite the convenience of uniform sampling, such a sampling strategy struggles to provide sufficient coverage of the parameter space in higher dimensions. Compare the following sampling coverage in 2D:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">qmc</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">random_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>

<span class="n">grid_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">grid_size</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">grid_size</span>
<span class="p">)</span>
<span class="n">grid_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">grid_x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

<span class="n">sobol_engine</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">Sobol</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">scramble</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sobol_samples</span> <span class="o">=</span> <span class="n">sobol_engine</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">grid_samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">grid_samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Grid-Based Uniform Sampling&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">random_samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">random_samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Random Sampling&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sobol_samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sobol_samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sobol Sampling&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/e973dd09e631a494c20e60aedfc92a2c6375ebc981e2314773a3c02bd0201e98.png" src="../_images/e973dd09e631a494c20e60aedfc92a2c6375ebc981e2314773a3c02bd0201e98.png" />
</div>
</div>
<p>In 2D, uniformly sampled points may seem well distributed to the eye. However, in higher dimensions:</p>
<ul class="simple">
<li><p>The volume of the space increases exponentially, while the number of samples may remain fixed.</p></li>
<li><p>The distance between neighboring points increases, leaving large gaps in the sampled space.</p></li>
<li><p>Most points tend to lie near the edges or corners of the domain, not near the center.</p></li>
</ul>
<p>The following plot shows this by calculating the average pairwise distance between sampling approaches over an increasing number of dimensions.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">qmc</span>

<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">4</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="n">dims</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">avg_dist_random</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">avg_dist_uniform</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">avg_dist_sobol</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
    <span class="n">rand_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">avg_dist_random</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">rand_pts</span><span class="p">)))</span>

    <span class="n">grid_pts_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">d</span><span class="p">))))</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">grid_pts_1d</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
    <span class="n">grid_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">grid_pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grid_pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">grid_pts</span> <span class="o">=</span> <span class="n">grid_pts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    
<span class="c1">#     grid_pts = grid_pts[:n_samples]  # Trim to match n_samples</span>
    <span class="n">avg_dist_uniform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">grid_pts</span><span class="p">)))</span>

    <span class="n">sobol_engine</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">Sobol</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">scramble</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sobol_pts</span> <span class="o">=</span> <span class="n">sobol_engine</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="n">avg_dist_sobol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">sobol_pts</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">avg_dist_random</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random Sampling&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">avg_dist_uniform</span><span class="p">,</span> <span class="s1">&#39;s-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Uniform Grid Sampling&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">avg_dist_sobol</span><span class="p">,</span> <span class="s1">&#39;^-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sobol Sampling&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Dimensions&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average Pairwise Distance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Average Pairwise Distance vs. Dimension&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/ba5830a2d17862fa6705d63f0f0f11877f8973c2530d55022b51925c63a065ce.png" src="../_images/ba5830a2d17862fa6705d63f0f0f11877f8973c2530d55022b51925c63a065ce.png" />
</div>
</div>
<p>Although both random and Sobol sampling may show similar <em>average distances</em> between points in high-dimensional space, this does not mean they cover the space equally well.</p>
<ul class="simple">
<li><p>Random sampling can leave clumps and gaps.</p></li>
<li><p>Sobol sampling aims to fill the space evenly, which is better for interpolation, optimization, and numerical integration.</p></li>
</ul>
<p>This is why metrics like <strong>centered discrepancy</strong> are often more informative than just pairwise distance.</p>
<div class="tip admonition">
<p class="admonition-title">What is Sobol Sampling?</p>
<p><strong>Sobol sequences</strong> are a class of <em>quasi-random low-discrepancy sequences</em> designed to sample points in high-dimensional spaces more uniformly than purely random or grid-based methods. They are particularly effective for numerical integration, model interpolation, and stellar grid sampling.</p>
<blockquote>
<div><p><em>Sobol numbers are a sequence of <span class="math notranslate nohighlight">\(m\)</span>-dimensional vectors <span class="math notranslate nohighlight">\(x_1, x_2, \dots, x_n\)</span> in the unit hypercube <span class="math notranslate nohighlight">\([0,1]^m\)</span>, constructed such that the integral of a real function <span class="math notranslate nohighlight">\(f\)</span> in that space is equivalent in the limit to the function evaluated over the sequence:</em></p>
<div class="math notranslate nohighlight">
\[
\int_{[0,1]^m} f(x)\,dx = \lim_{n \to \infty} \frac{1}{n} \sum_{i=1}^{n} f(x_i)
\]</div>
<p>with the sequence being chosen such that the convergence is
achieved as quickly as possible <em>(Bellinger et al. 2016, ApJ 830:31)</em>.</p>
</div></blockquote>
<p>Sobol sampling ensures that model grids (e.g., over mass, metallicity, age, etc.) fill the space as uniformly as possible, while avoiding clumping or redundant sampling.</p>
<p><strong>See also</strong>: <a class="reference external" href="https://iopscience.iop.org/article/10.3847/0004-637X/830/1/31/pdf">Bellinger et al. (2016)</a>, <em>Figure 14</em> — a comparison of linear, random, and Sobol sampling in a 3D unit cube projected onto 2D, showing the superior space-filling behavior of Sobol methods.</p>
</div>
<section id="the-discrepancy-metric">
<h3>The Discrepancy Metric<a class="headerlink" href="#the-discrepancy-metric" title="Permalink to this headline">#</a></h3>
<p>The <strong>centered L²-discrepancy</strong> is a measure of how uniformly a set of sample points fills a multi-dimensional unit cube <span class="math notranslate nohighlight">\([0, 1]^d\)</span>. It is particularly useful for comparing different sampling strategies.</p>
<p>In high-dimensional inference (e.g., stellar modeling), uniform coverage of parameter space becomes difficult. Discrepancy helps assess <strong>how well your sample points cover the space</strong>, especially near the center and along diagonals, which are places where random sampling tends to leave gaps.</p>
<p>Let <span class="math notranslate nohighlight">\(\mathbf{x}^{(i)} \in [0,1]^d\)</span> be the <span class="math notranslate nohighlight">\(i\)</span>-th point in a set of <span class="math notranslate nohighlight">\(n\)</span> total samples. Then the <strong>centered L²-discrepancy</strong> <span class="math notranslate nohighlight">\(D_C^2(P)\)</span> is given by <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1998MaCom..67..299H/abstract">Hickernell (1998)</a> as:</p>
<div class="math notranslate nohighlight">
\[
D_C^2(P) = \overbrace{\left( \frac{13}{12} \right)^d}^{\text{Term 1}}
- \overbrace{\frac{2}{n} \sum_{i=1}^n \prod_{j=1}^d \left(1 + \frac{1}{2}|x^{(i)}_j - 0.5| - \frac{1}{2}(x^{(i)}_j - 0.5)^2 \right)}^{\text{Term 2}} 
+ \overbrace{\frac{1}{n^2} \sum_{i=1}^n \sum_{k=1}^n \prod_{j=1}^d \left(1 - \max(x^{(i)}_j, x^{(k)}_j) \right)}^{\text{Term 3}}
\]</div>
<ul class="simple">
<li><p><strong>Term 1</strong>: Reference value for perfect uniformity:<br />
<span class="math notranslate nohighlight">\(\left( \frac{13}{12} \right)^d\)</span></p></li>
<li><p><strong>Term 2</strong>: Penalizes deviation from the center. The product ensures that offset from 0.5 is measured across all dimensions.</p></li>
<li><p><strong>Term 3</strong>: Penalizes clustering. This double sum detects whether points are too close to each other in high-dimensional space.</p></li>
</ul>
<p>Overall, this form of measuring discrepancy promotes evenly spread points with good center coverage, and penalizes points that are clumped or miss the center with a high discrepancy value.</p>
<p>In practice, <code class="docutils literal notranslate"><span class="pre">scipy.stats.qmc.discrepancy()</span></code> can be used to compute it for sampled point sets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">qmc</span>

<span class="c1">## Number Of Samples ##</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1">## Generate 2D Uniform Samples ##</span>
<span class="n">num_per_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">dim</span><span class="p">))</span>
<span class="n">linspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_per_dim</span><span class="p">)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">linspace</span><span class="p">]</span> <span class="o">*</span> <span class="n">dim</span><span class="p">))</span>
<span class="n">uniform_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
<span class="n">uniform_discrep</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">discrepancy</span><span class="p">(</span><span class="n">uniform_points</span><span class="p">)</span> <span class="c1"># uniform sample discrepancy</span>

<span class="c1">## Generate 2D Random Samples ##</span>
<span class="n">random_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
<span class="n">random_discrep</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">discrepancy</span><span class="p">(</span><span class="n">random_samples</span><span class="p">)</span> <span class="c1"># random sample discrepancy</span>

<span class="c1">## Generate 2D Sobol Samples ##</span>
<span class="n">sobol_engine</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">Sobol</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">scramble</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sobol_samples</span> <span class="o">=</span> <span class="n">sobol_engine</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">sobol_discrep</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">discrepancy</span><span class="p">(</span><span class="n">sobol_samples</span><span class="p">)</span> <span class="c1"># Sobol sample discrepancy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">uniform_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">uniform_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Uniform Sampling</span><span class="se">\n</span><span class="s1">Discrepancy ($</span><span class="se">\\</span><span class="s1">times 10^{-6}$): </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">uniform_discrep</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">random_samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">random_samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Random Sampling</span><span class="se">\n</span><span class="s1">Discrepancy ($</span><span class="se">\\</span><span class="s1">times 10^{-6}$): </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">random_discrep</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sobol_samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sobol_samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sobol Sampling</span><span class="se">\n</span><span class="s1">Discrepancy ($</span><span class="se">\\</span><span class="s1">times 10^{-6}$): </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">sobol_discrep</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/4284947e41c97464fc599c2a4a977d550ba8165eee386d714b22543a1232226f.png" src="../_images/4284947e41c97464fc599c2a4a977d550ba8165eee386d714b22543a1232226f.png" />
</div>
</div>
<p>We can see that as the number of dimensions increase, Sobol sampling provides the lowest discrepancy compared to uniform and random sampling.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">qmc</span>

<span class="c1"># Settings</span>
<span class="n">dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># Storage for results</span>
<span class="n">discrep_random</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">discrep_sobol</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">discrep_grid</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
    
    <span class="c1"># Random sampling</span>
    <span class="n">rand_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">discrep_random</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qmc</span><span class="o">.</span><span class="n">discrepancy</span><span class="p">(</span><span class="n">rand_points</span><span class="p">))</span>
    
    <span class="c1"># Sobol sampling</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">qmc</span><span class="o">.</span><span class="n">Sobol</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">scramble</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sobol_points</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">discrep_sobol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qmc</span><span class="o">.</span><span class="n">discrepancy</span><span class="p">(</span><span class="n">sobol_points</span><span class="p">))</span>

    <span class="n">num_per_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">samples</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">d</span><span class="p">))</span>
    <span class="n">linspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_per_dim</span><span class="p">)</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">linspace</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
    <span class="n">grid_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">discrep_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qmc</span><span class="o">.</span><span class="n">discrepancy</span><span class="p">(</span><span class="n">grid_points</span><span class="p">))</span>

<span class="c1"># Plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">discrep_random</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random Sampling&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">discrep_sobol</span><span class="p">,</span> <span class="s1">&#39;s-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sobol Sampling&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">discrep_grid</span><span class="p">,</span> <span class="s1">&#39;^-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Uniform Grid Sampling&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Dimensionality&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Discepancy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/0eb7eb8da0b2c74b060128edbf3ced4b94ce9e6fc05cb9db8cf2185d34aef633.png" src="../_images/0eb7eb8da0b2c74b060128edbf3ced4b94ce9e6fc05cb9db8cf2185d34aef633.png" />
</div>
</div>
</section>
</section>
<section id="linear-interpolation-using-eeps">
<h2>Linear Interpolation using EEPs<a class="headerlink" href="#linear-interpolation-using-eeps" title="Permalink to this headline">#</a></h2>
<p>The EEPs provide a regular set of points over which we can perform linear interpolation. To facilitate this, we can use the <a class="reference external" href="https://isochrones.readthedocs.io/en/latest/interpolate.html"><code class="docutils literal notranslate"><span class="pre">DFInterpolator</span></code></a> tool from the <code class="docutils literal notranslate"><span class="pre">isochrones</span></code> library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">isochrones.interp</span> <span class="kn">import</span> <span class="n">DFInterpolator</span>

<span class="n">interpolator</span> <span class="o">=</span> <span class="n">DFInterpolator</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
</pre></div>
</div>
<div class="important admonition">
<p class="admonition-title">Interpolating with DFInterpolator</p>
<p><code class="docutils literal notranslate"><span class="pre">DFInterpolator</span></code> enables multi-dimensional interpolation over specified DataFrame columns by treating them as interpolation axes. To use it, the relevant columns must first be moved into the DataFrame index using:
<code class="docutils literal notranslate"><span class="pre">df.set_index(['col1',</span> <span class="pre">'col2',</span> <span class="pre">'col3',</span> <span class="pre">...])</span></code>.
This defines the coordinate space over which interpolation is performed. The remaining columns in the DataFrame are then treated as the target quantities to be interpolated.</p>
</div>
<p>To see this in action, let us first split the grid of models into a <strong>sub-sampled subset</strong> that we will use for the interpolation, and a separate <strong>hold-out</strong> subset that we will use to examine the interpolation quality.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_subsampled_grid</span><span class="p">(</span><span class="n">subsampling_factor_mass</span><span class="p">,</span> <span class="n">subsampling_factor_feh</span><span class="p">):</span>

    <span class="n">x_mass</span> <span class="o">=</span> <span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">x_feh</span> <span class="o">=</span> <span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;initial_met&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="n">unique_mass_met</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x_mass</span><span class="p">,</span><span class="n">x_feh</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># unique tuples of mass and met</span>

    <span class="n">subsampled_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_mass</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">subsampling_factor_mass</span><span class="p">]</span>
    <span class="n">subsampled_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">subsampled_mass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_mass</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">subsampled_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subsampled_mass</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_mass</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">subsampled_feh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_feh</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">subsampling_factor_feh</span><span class="p">]</span>
    <span class="n">subsampled_feh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">subsampled_feh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_feh</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">subsampled_feh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subsampled_feh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_feh</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">subsampled_massmet</span> <span class="o">=</span> <span class="n">unique_mass_met</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">unique_mass_met</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">subsampled_mass</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">unique_mass_met</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">subsampled_feh</span><span class="p">)]</span>

    <span class="n">validation_massmet</span> <span class="o">=</span> <span class="n">unique_mass_met</span><span class="p">[</span>
        <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">unique_mass_met</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">subsampled_mass</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">unique_mass_met</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">subsampled_feh</span><span class="p">))]</span>

    <span class="n">reduc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">x_mass</span><span class="p">,</span> <span class="n">subsampled_massmet</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">x_feh</span><span class="p">,</span> <span class="n">subsampled_massmet</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">x_mass_subsampled</span><span class="p">,</span> <span class="n">x_feh_subsampled</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">reduc</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x_mass</span><span class="p">,</span> <span class="n">x_feh</span><span class="p">))</span>
    <span class="n">x_mass_holdout</span><span class="p">,</span> <span class="n">x_feh_holdout</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="o">~</span><span class="n">reduc</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x_mass</span><span class="p">,</span> <span class="n">x_feh</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">x_mass_subsampled</span><span class="p">,</span> <span class="n">x_feh_subsampled</span><span class="p">,</span> <span class="n">x_mass_holdout</span><span class="p">,</span> <span class="n">x_feh_holdout</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">subsampling_factor_mass</span></code> and <code class="docutils literal notranslate"><span class="pre">subsampling_factor_feh</span></code> controls the degree to which the grid is subsampled in initial mass and initial metallicity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subsampling_factor_mass</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># integer factor to which initial mass in the grid is subsampled</span>
<span class="n">subsampling_factor_feh</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># integer factor to which initial metallicity in the grid is subsampled</span>

<span class="n">x_mass_subsampled</span><span class="p">,</span> <span class="n">x_feh_subsampled</span><span class="p">,</span> \
<span class="n">x_mass_holdout</span><span class="p">,</span> <span class="n">x_feh_holdout</span> <span class="o">=</span> <span class="n">get_subsampled_grid</span><span class="p">(</span><span class="n">subsampling_factor_mass</span><span class="p">,</span> <span class="n">subsampling_factor_feh</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_mass_subsampled</span><span class="p">,</span> <span class="n">x_feh_subsampled</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;Models to be Interpolated&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_mass_holdout</span><span class="p">,</span> <span class="n">x_feh_holdout</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Holdout Models&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Initial Metallicity (dex)&#39;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Initial Mass ($M_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">fs</span><span class="p">},</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/8f0cf91b60e2c8b7a41400f1769d0c68139f10d3721bb35ffd9f28839adb8266.png" src="../_images/8f0cf91b60e2c8b7a41400f1769d0c68139f10d3721bb35ffd9f28839adb8266.png" />
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The downsampling by <code class="docutils literal notranslate"><span class="pre">get_subsampled_grid</span></code> preserves models near the edge of the grid to make sure that the interpolation is kept consistently within boundaries. In other words, no extrapolation occurs.</p>
</div>
<p>In the following, we define</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">training_df</span></code>: DataFrame containing initial mass and metallicity of models to be interpolated over</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validation_df</span></code> DataFrame containing initial mass and metallicity of holdout models</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Training DF ##</span>

<span class="c1">## find unique subsampled initial mass and initial metallicity ##</span>
<span class="n">subsampled_massmet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x_mass_subsampled</span><span class="p">,</span><span class="n">x_feh_subsampled</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">selected_pairs</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subsampled_massmet</span><span class="p">]</span>

<span class="c1">## build a mask over the original DataFrame to select only those subsampled values ##</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_met&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_pairs</span><span class="p">)</span>

<span class="c1">## Use the mask to subset the original DataFrame</span>
<span class="n">training_df</span> <span class="o">=</span> <span class="n">rg_grid</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="n">mask</span><span class="p">]</span>


<span class="c1">## Validation DF ##</span>

<span class="n">validation_massmet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x_mass_holdout</span><span class="p">,</span><span class="n">x_feh_holdout</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">selected_pairs</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">validation_massmet</span><span class="p">]</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_met&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_pairs</span><span class="p">)</span>
<span class="n">validation_df</span> <span class="o">=</span> <span class="n">rg_grid</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="n">mask</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training_df</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_met&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">])</span>
<span class="n">training_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>teff</th>
      <th>rad</th>
      <th>age</th>
    </tr>
    <tr>
      <th>initial_mass</th>
      <th>initial_met</th>
      <th>step</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1.3</th>
      <th rowspan="5" valign="top">-1.25</th>
      <th>453</th>
      <td>3.941125</td>
      <td>0.237314</td>
      <td>2.205380</td>
    </tr>
    <tr>
      <th>454</th>
      <td>3.937966</td>
      <td>0.247855</td>
      <td>2.217799</td>
    </tr>
    <tr>
      <th>455</th>
      <td>3.934595</td>
      <td>0.258536</td>
      <td>2.228859</td>
    </tr>
    <tr>
      <th>456</th>
      <td>3.931033</td>
      <td>0.269315</td>
      <td>2.238671</td>
    </tr>
    <tr>
      <th>457</th>
      <td>3.927306</td>
      <td>0.280156</td>
      <td>2.247375</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">validation_df</span> <span class="o">=</span> <span class="n">validation_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_met&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">])</span>
<span class="n">validation_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>teff</th>
      <th>rad</th>
      <th>age</th>
    </tr>
    <tr>
      <th>initial_mass</th>
      <th>initial_met</th>
      <th>step</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1.34</th>
      <th rowspan="5" valign="top">-1.25</th>
      <th>453</th>
      <td>3.951350</td>
      <td>0.238106</td>
      <td>1.991584</td>
    </tr>
    <tr>
      <th>454</th>
      <td>3.948183</td>
      <td>0.248621</td>
      <td>2.003444</td>
    </tr>
    <tr>
      <th>455</th>
      <td>3.944806</td>
      <td>0.259264</td>
      <td>2.013925</td>
    </tr>
    <tr>
      <th>456</th>
      <td>3.941241</td>
      <td>0.269994</td>
      <td>2.023172</td>
    </tr>
    <tr>
      <th>457</th>
      <td>3.937502</td>
      <td>0.280782</td>
      <td>2.031301</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>With the indices now defined, it is straightforward to define the linear interpolator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">isochrones.interp</span> <span class="kn">import</span> <span class="n">DFInterpolator</span>

<span class="n">train_interpolator</span> <span class="o">=</span> <span class="n">DFInterpolator</span><span class="p">(</span><span class="n">training_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The syntax for the interpolation is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_interpolator</span><span class="p">([</span><span class="n">initial_mass</span><span class="p">,</span> <span class="n">initial_met</span><span class="p">,</span> <span class="n">step</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Experiment with a variety of values in <code class="docutils literal notranslate"><span class="pre">train_interpolator</span></code>, including a list of values. For instance,</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">train_interpolator([</span> <span class="pre">[1.5,</span> <span class="pre">1.6],</span> <span class="pre">[-0.5,</span> <span class="pre">0.2],</span> <span class="pre">[455,</span> <span class="pre">455]])</span></code></p>
</div></blockquote>
<p>provides:</p>
<ul class="simple">
<li><p>The interpolation at EEP 455 of a model with initial mass of 1.5 <span class="math notranslate nohighlight">\(M_{\odot}\)</span> and an initial metallicity of -0.5 dex.</p></li>
<li><p>The interpolation at EEP 455 of a model with initial mass of 1.6 <span class="math notranslate nohighlight">\(M_{\odot}\)</span> and an initial metallicity of 0.2 dex at the same EEP.</p></li>
</ul>
<p>Meanwhile,</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">train_interpolator([</span> <span class="pre">[1.5,</span> <span class="pre">1.5],</span> <span class="pre">[-0.5,</span> <span class="pre">-0.5],</span> <span class="pre">[454,</span> <span class="pre">455]])</span></code></p>
</div></blockquote>
<p>Provides interpolation across EEPs 454 and 455 for a model withinitial mass of 1.5 <span class="math notranslate nohighlight">\(M_{\odot}\)</span> and an initial metallicity of -0.5 dex.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">plot_linear_interpolations</span></code> below, experiment with varying <code class="docutils literal notranslate"><span class="pre">idx</span></code> to change the reference mass at which the interpolation occurs.</p>
</div>
<p>This allows interpolation at individual values or across a continuous range, shown in the following:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_linear_interpolations</span><span class="p">(</span><span class="n">fixed_mass</span><span class="p">):</span>
    
    <span class="n">met_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;viridis&#39;</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">met_range</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">met_range</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">validation_massmet</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fixed_mass</span><span class="p">:</span>
            <span class="n">init_metallicity</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="n">validation_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">init_metallicity</span><span class="p">,</span> <span class="n">steps</span><span class="p">)][</span><span class="s1">&#39;teff&#39;</span><span class="p">],</span>
                     <span class="mi">10</span><span class="o">**</span><span class="n">validation_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">init_metallicity</span><span class="p">,</span> <span class="n">steps</span><span class="p">)][</span><span class="s1">&#39;rad&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span>
                    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="n">train_interpolator</span><span class="p">([</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">init_metallicity</span><span class="p">,</span> <span class="n">steps</span><span class="p">])[::</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                     <span class="mi">10</span><span class="o">**</span><span class="n">train_interpolator</span><span class="p">([</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">init_metallicity</span><span class="p">,</span> <span class="n">steps</span><span class="p">])[::</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">999</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">met_range</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">met</span><span class="p">))</span>

                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="n">train_interpolator</span><span class="p">([</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">met</span><span class="p">,</span> <span class="n">steps</span><span class="p">])[:,</span><span class="mi">0</span><span class="p">],</span>
                         <span class="mi">10</span><span class="o">**</span><span class="n">train_interpolator</span><span class="p">([</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">met</span><span class="p">,</span> <span class="n">steps</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>           
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>         
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">6500</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$T_{</span><span class="se">\\</span><span class="s1">mathrm</span><span class="si">{eff}</span><span class="s1">}$ (K)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Radius ($R_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Holdout Tracks&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],[],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Interpolated EEPs&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">})</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Initial [Fe/H] from </span><span class="si">{</span><span class="n">met_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">met_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> dex</span><span class="se">\n</span><span class="s1">in increments of 0.25 dex&#39;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    
    <span class="n">sm</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Metallicity (dex)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">fixed_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">validation_massmet</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])[</span><span class="n">idx</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fixed Mass is </span><span class="si">{</span><span class="n">fixed_mass</span><span class="si">}</span><span class="s1"> Msol&#39;</span><span class="p">)</span>

<span class="n">plot_linear_interpolations</span><span class="p">(</span><span class="n">fixed_mass</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fixed Mass is 1.86 Msol
</pre></div>
</div>
<img alt="../_images/c382e5f289270692c4b838f047e1a1c7d0cf09f41e820b353b993f185a01f649.png" src="../_images/c382e5f289270692c4b838f047e1a1c7d0cf09f41e820b353b993f185a01f649.png" />
</div>
</div>
<p>On the left, we are interpolating from the downsampled grid to an <strong>initial mass value only present in the validation set of models</strong>. At that initial mass value, we are examining the interpolation over a <strong>discrete range</strong> of initial metallicities, matching the grid values of (<code class="docutils literal notranslate"><span class="pre">initial_mass</span></code>, <code class="docutils literal notranslate"><span class="pre">initial_met</span></code>) in the validation set.</p>
<p>On the right, we see that interpolation allows us to estimate the evolutionary tracks across <strong>a continuous range</strong> of initial metallicity values.</p>
<p><strong>Key Observations</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>The interpolated EEPs are not perfect. It may be inaccurate <span class="math notranslate nohighlight">\(T_{\mathrm{eff}}-\)</span>radius regions where the tracks evolve quickly.</p></li>
<li><p>By interpolating over a continuous range, we observe that output stellar properties are <strong>mostly smoothly varying</strong> with respect to the input parameters.</p></li>
</ul>
</div></blockquote>
</section>
<section id="beyond-linear-interpolation-emulation">
<h2>Beyond Linear Interpolation: Emulation<a class="headerlink" href="#beyond-linear-interpolation-emulation" title="Permalink to this headline">#</a></h2>
<p>While linear interpolation is a simple and effective way to estimate stellar properties between known grid points, it encounters significant limitations in higher-dimensional parameter spaces:</p>
<ul class="simple">
<li><p><strong>Dimensionality scaling</strong>: In D-dimensional space, linear interpolation becomes increasingly inaccurate as the number of input parameters grows as the space between points grow larger.</p></li>
<li><p><strong>Grid rigidity</strong>: Traditional interpolation requires a grid regularly sampled in Equivalent Evolutionary Phases (EEPs). Defining EEPs is an added complication, given that evolutionary tracks often vary in length and sampling.</p></li>
<li><p><strong>Nonlinearity</strong>: Stellar properties change nonlinearly across parameters like mass, metallicity, and age. Linear methods poorly approximate such curvature, especially near key evolutionary transitions.</p></li>
</ul>
<section id="emulating-stellar-grids-with-neural-networks">
<h3>Emulating Stellar Grids with Neural Networks<a class="headerlink" href="#emulating-stellar-grids-with-neural-networks" title="Permalink to this headline">#</a></h3>
<p>Instead of relying on interpolation, we can learn a continuous, differentiable mapping from stellar parameters (e.g., mass, age, [Fe/H]) to observables (e.g., <span class="math notranslate nohighlight">\(T_{\mathrm{eff}}\)</span>, <span class="math notranslate nohighlight">\(\log (g)\)</span>, asteroseismic values) using a neural network emulator. As seen in <a class="reference internal" href="../chapter2/spectra-3.html#content-references-spectra-part3"><span class="std std-ref">Stellar Spectra Part 3: The Payne</span></a>, neural networks can be used to emulate high-dimensional data very effectively. In the context of a grid of models, this method in principle will be able to:</p>
<ul class="simple">
<li><p>Handle <span class="math notranslate nohighlight">\(D-D\)</span> interpolation naturally without requiring a structured grid.</p></li>
<li><p>Capture nonlinear variations across parameter space more accurately than linear interpolators.</p></li>
<li><p>Relax the requirement for EEPs or regridding as the model learns directly from raw evolutionary track outputs.</p></li>
</ul>
<p>This motivates our next step: training a neural emulator to serve as a flexible surrogate model of the stellar grid.</p>
</section>
</section>
<section id="normalizing-flows-as-a-grid-emulator">
<h2>Normalizing Flows as a Grid Emulator<a class="headerlink" href="#normalizing-flows-as-a-grid-emulator" title="Permalink to this headline">#</a></h2>
<p>Instead of using an ordinary multilayer perceptron as our emulator, we will use <strong>normalizing flows</strong> to perform the task. The key insight here is that the input parameter space and the observable space spanned by the grid can be thought of as <strong>multi-dimensional conditional distributions</strong> to be modelled by the flow.</p>
<p>We will use a Neural Spline Flow as implemented by the <code class="docutils literal notranslate"><span class="pre">zuko</span></code> library to model the output observable distribution, <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> <strong>conditioned</strong> on the input parameter space, <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>. This forms a <strong>Conditional Normalizing Flow</strong> that maps the multi-dimensional distributions <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### IMPORTS ###</span>

<span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">zuko</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span> <span class="k">as</span> <span class="nn">utils</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">torch.optim.lr_scheduler</span> <span class="kn">import</span> <span class="n">ReduceLROnPlateau</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="n">teff_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Define Training Set and Torch Dataloader ##</span>

<span class="n">x_mass_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">x_feh_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">&#39;initial_met&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">y_teff_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">&#39;teff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_teff_train</span> <span class="o">=</span> <span class="n">teff_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_teff_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">y_rad_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">&#39;rad&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_age_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span> <span class="n">x_mass_train</span><span class="p">,</span> <span class="n">x_feh_train</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span> <span class="n">y_teff_train</span><span class="p">,</span> <span class="n">y_rad_train</span><span class="p">,</span> <span class="n">y_age_train</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span> <span class="o">=</span> <span class="n">zuko</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">NSF</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">Y_train</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>  <span class="n">context</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> 
                      <span class="n">transforms</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">hidden_features</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># define the flow</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_lr</span> <span class="o">=</span> <span class="mf">1E-12</span><span class="p">)</span>
<span class="n">iterations</span> <span class="o">=</span> <span class="mi">150</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Training Loop ##</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
    <span class="n">i</span><span class="o">+=</span> <span class="mi">1</span>
    <span class="n">loss_vec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">X_inp</span><span class="p">,</span> <span class="n">Y_inp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">train_dataloader</span><span class="p">:</span>
        
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">flow</span><span class="p">(</span><span class="n">X_inp</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">Y_inp</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">loss_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        
<span class="c1">#     flow.eval()</span>
<span class="c1">#     with torch.no_grad():</span>
<span class="c1">#</span>
<span class="c1">#     ####################################################### </span>
<span class="c1">#     ###  Insert Code Block for Validation Testing Here ####</span>
<span class="c1">#     ####################################################### </span>
<span class="c1">#      </span>
<span class="c1">#     ####################################################### </span>
        
    <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_vec</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iterations: </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">, Train Loss: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_vec</span><span class="p">)))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iterations: 10/150, Train Loss: -4.2067
Iterations: 20/150, Train Loss: -4.9759
Iterations: 30/150, Train Loss: -5.4604
Iterations: 40/150, Train Loss: -5.7503
Epoch 00047: reducing learning rate of group 0 to 5.0000e-04.
Iterations: 50/150, Train Loss: -6.6224
Iterations: 60/150, Train Loss: -6.9687
Epoch 00067: reducing learning rate of group 0 to 2.5000e-04.
Iterations: 70/150, Train Loss: -7.7747
Iterations: 80/150, Train Loss: -7.9877
Epoch 00087: reducing learning rate of group 0 to 1.2500e-04.
Iterations: 90/150, Train Loss: -8.5918
Epoch 00099: reducing learning rate of group 0 to 6.2500e-05.
Iterations: 100/150, Train Loss: -9.0844
Iterations: 110/150, Train Loss: -9.1589
Epoch 00119: reducing learning rate of group 0 to 3.1250e-05.
Iterations: 120/150, Train Loss: -9.4502
Epoch 00125: reducing learning rate of group 0 to 1.5625e-05.
Iterations: 130/150, Train Loss: -9.5911
Iterations: 140/150, Train Loss: -9.6263
Epoch 00141: reducing learning rate of group 0 to 7.8125e-06.
Iterations: 150/150, Train Loss: -9.7068
</pre></div>
</div>
</div>
</div>
<section id="visualizing-the-emulated-distribution-from-the-trained-flow">
<h3>Visualizing the Emulated Distribution from the Trained Flow<a class="headerlink" href="#visualizing-the-emulated-distribution-from-the-trained-flow" title="Permalink to this headline">#</a></h3>
<p>Given that we are treating the grid of models as a <strong>continuous distribution</strong>, we can use a corner plot to visualize how the emulation of output parameters compares to the original, <strong>when conditioned on the same distribution of input parameters.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_samps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_logprobs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">x_s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="p">(</span><span class="n">X_inp</span><span class="p">,</span> <span class="n">Y_inp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">train_dataloader</span><span class="p">:</span>
    
    <span class="n">y_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_inp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="c1"># storing the training Y</span>
    <span class="n">x_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_inp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="c1"># storing the training X</span>
    
    <span class="n">samps</span><span class="p">,</span><span class="n">logprobs</span> <span class="o">=</span> <span class="n">flow</span><span class="p">(</span><span class="n">X_inp</span><span class="p">)</span><span class="o">.</span><span class="n">rsample_and_log_prob</span><span class="p">()</span> <span class="c1"># obtain samples and their log probabilities</span>
    
    <span class="n">y_samps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samps</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="c1"># storing the emulated Y (samples)</span>
    <span class="n">y_logprobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logprobs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="c1"># storing the log probabilities of emulated Y</span>

<span class="n">y_samps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_samps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x_s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y_logprobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_logprobs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="important admonition">
<p class="admonition-title">Flow Notation</p>
<p>The enable the normalizing flow to be <strong>conditional</strong>, the flow instance needs to accept the conditioning vector <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> upon its invocation. Notice the following code lines in the above blocks:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">loss</span> <span class="pre">=</span> <span class="pre">-flow(X_inp).log_prob(Y_inp)</span></code></p>
</div></blockquote>
<p>Here, the flow object receives the conditioning batch <code class="docutils literal notranslate"><span class="pre">X_inp</span></code> and the corresponding output distribution batch <code class="docutils literal notranslate"><span class="pre">Y_inp</span></code>.</p>
<p>Next, we have</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">samps,logprobs</span> <span class="pre">=</span> <span class="pre">flow(X_inp).rsample_and_log_prob()</span></code></p>
</div></blockquote>
<p>where again the object receives <code class="docutils literal notranslate"><span class="pre">X_inp</span></code> before sampling. The samples are then specifically conditioned on the values of <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> passed.</p>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="n">cond</span> <span class="o">=</span> <span class="n">y_logprobs</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">y_logprobs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Scaled $T_{</span><span class="se">\\</span><span class="s1">mathrm</span><span class="si">{eff}</span><span class="s1">}$&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">log_</span><span class="si">{10}</span><span class="s1"> R$ ($R_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">tau$ (Gyr)&#39;</span><span class="p">,</span>
         <span class="p">]</span>

<span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">y_samps</span><span class="p">[</span><span class="n">cond</span><span class="p">],</span><span class="n">label_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="n">fs</span><span class="p">},</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">y_s</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Emulated Samples&#39;</span><span class="p">),</span>
           <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Original Grid Distribution&#39;</span><span class="p">)]</span>

<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/843202b1e072fed237c8d9914dd2048cfd52a2cb173a8944b61e7b481ab25b37.png" src="../_images/843202b1e072fed237c8d9914dd2048cfd52a2cb173a8944b61e7b481ab25b37.png" />
</div>
</div>
<div class="note admonition">
<p class="admonition-title">Exercise</p>
<p>You have just trained a flow-based emulator on the training set without any form of validation. To assess its performance and generalizability, do the following:</p>
<ul class="simple">
<li><p><strong>Qualitative Evaluation</strong></p>
<ul>
<li><p>Visually compare the emulator’s predictions to the original data distribution. In which regions of parameter space does the emulator struggle to reproduce the structure? Use the corner plot above as a reference.</p></li>
</ul>
</li>
<li><p><strong>Implement Validation</strong></p>
<ul>
<li><p>Define a <code class="docutils literal notranslate"><span class="pre">ValidationDataset</span></code> using <code class="docutils literal notranslate"><span class="pre">validation_df</span></code>.</p></li>
<li><p>Integrate validation loss tracking into the training loop. Record the validation loss at each epoch.</p></li>
</ul>
</li>
<li><p><strong>Benchmarking</strong></p>
<ul>
<li><p>Quantitatively compare training and validation losses.</p></li>
<li><p>Qualitatively assess the validation predictions using the same corner plot diagnostics.</p></li>
</ul>
</li>
</ul>
<p><em>Optional</em>: Reflect on whether certain parameters (e.g. mass, age, [Fe/H]) are more difficult for the flow to capture. What might this suggest about the model’s inductive bias or the density of training data in those regions?</p>
</div>
<p>Since the normalizing flow is a generative model, we <strong>draw samples</strong> from it in order to obtain predictions of observables like <span class="math notranslate nohighlight">\(T_{\mathrm{eff}}\)</span> and radius. To obtain evolutionary tracks of a specific <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>, (e.g., <span class="math notranslate nohighlight">\(M\)</span>, [Fe/H]) we specify their values in the conditioning vector <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>.</p>
</section>
<section id="scenario-1-emulating-an-individual-track">
<h3>Scenario 1: Emulating an individual track<a class="headerlink" href="#scenario-1-emulating-an-individual-track" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_samps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">fixed_mass</span> <span class="o">=</span> <span class="mf">1.9</span>
<span class="n">fixed_met</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">cond_vec_single</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_samps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>  <span class="c1"># shape of (N, num initial parameters)</span>
<span class="n">cond_vec_single</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_mass</span>  <span class="c1"># first column is for init mass</span>
<span class="n">cond_vec_single</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_met</span> <span class="c1"># second column is for init met #np.random.uniform(low=0.25, high=-1.25, size=num_samps)</span>
<span class="n">cond_vec_single</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">cond_vec_single</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">single_track_prediction</span> <span class="o">=</span> <span class="n">flow</span><span class="p">(</span><span class="n">cond_vec_single</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="c1"># shape of (N, num output observables)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="scenario-2-emulating-a-continuum-of-tracks">
<h3>Scenario 2: Emulating a continuum of tracks<a class="headerlink" href="#scenario-2-emulating-a-continuum-of-tracks" title="Permalink to this headline">#</a></h3>
<p>Similar to the linear interpolation example, we will fix the initial mass and observe the tracks across a range of initial metallicity:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_samps</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">met_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">num_samps</span><span class="p">)</span>

<span class="n">cond_vec_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_samps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>  <span class="c1"># shape of (N, num initial parameters)</span>
<span class="n">cond_vec_range</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_mass</span>  <span class="c1"># first column is for init mass</span>
<span class="n">cond_vec_range</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">met_range</span> <span class="c1"># second column is for init met </span>
<span class="n">cond_vec_range</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">cond_vec_range</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">range_track_prediction</span> <span class="o">=</span> <span class="n">flow</span><span class="p">(</span><span class="n">cond_vec_range</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="c1"># shape of (N, num output observables)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_emulation</span><span class="p">(</span><span class="n">single_track_prediction</span><span class="p">,</span> <span class="n">range_track_prediction</span><span class="p">,</span> <span class="n">met_range</span><span class="p">,</span>
                  <span class="n">fixed_mass</span><span class="p">,</span> <span class="n">fixed_met</span><span class="p">):</span>
     
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rg_grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;viridis&#39;</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">met_range</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">met_range</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">teff_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">single_track_prediction</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> 
                <span class="mi">10</span><span class="o">**</span><span class="n">single_track_prediction</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>         
    
    <span class="n">im2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">teff_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">range_track_prediction</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> 
                <span class="mi">10</span><span class="o">**</span><span class="n">range_track_prediction</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">met_range</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">validation_massmet</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fixed_mass</span><span class="p">:</span>
            <span class="n">init_metallicity</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="mi">10</span><span class="o">**</span><span class="n">validation_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">init_metallicity</span><span class="p">,</span> <span class="n">steps</span><span class="p">)][</span><span class="s1">&#39;teff&#39;</span><span class="p">],</span>
                     <span class="mi">10</span><span class="o">**</span><span class="n">validation_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">init_metallicity</span><span class="p">,</span> <span class="n">steps</span><span class="p">)][</span><span class="s1">&#39;rad&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span>
                    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>      
        
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>         
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">6500</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$T_{</span><span class="se">\\</span><span class="s1">mathrm</span><span class="si">{eff}</span><span class="s1">}$ (K)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Radius ($R_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Holdout Tracks</span><span class="se">\n</span><span class="s1">at </span><span class="si">%.1f</span><span class="s1">$M_{</span><span class="se">\\</span><span class="s1">odot}$&#39;</span> <span class="o">%</span><span class="k">fixed_mass</span>)
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],[],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Emulated </span><span class="si">%.1f</span><span class="s1">$M_{</span><span class="se">\\</span><span class="s1">odot}$</span><span class="se">\n</span><span class="si">%.2f</span><span class="s1"> dex Track&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">fixed_mass</span><span class="p">,</span> <span class="n">fixed_met</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">})</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Holdout Initial [Fe/H] from </span><span class="si">{</span><span class="n">met_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">met_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> dex</span><span class="se">\n</span><span class="s1">in increments of 0.25 dex&#39;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
    
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Metallicity (dex)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_emulation</span><span class="p">(</span><span class="n">single_track_prediction</span><span class="p">,</span> <span class="n">range_track_prediction</span><span class="p">,</span> <span class="n">met_range</span><span class="p">,</span> <span class="n">fixed_mass</span><span class="p">,</span> <span class="n">fixed_met</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d0f9c265dccfcc5eaf621250bb303ca7e02da0f6139e9fafbd42784f10ad596c.png" src="../_images/d0f9c265dccfcc5eaf621250bb303ca7e02da0f6139e9fafbd42784f10ad596c.png" />
</div>
</div>
<p>Observe that in defining <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>, namely <code class="docutils literal notranslate"><span class="pre">cond_vec_single</span></code> and <code class="docutils literal notranslate"><span class="pre">cond_vec_range</span></code>, a separate column for EEP is not required. Indeed, this is one of the key strengths of the flow – in that interpolation can be done without having to explicitly enforce sampling regularity of models in the grid.</p>
</section>
</section>
<section id="flow-based-stellar-parameter-inference-sampling-importance-resampling">
<h2>Flow-based Stellar Parameter Inference: Sampling-Importance Resampling<a class="headerlink" href="#flow-based-stellar-parameter-inference-sampling-importance-resampling" title="Permalink to this headline">#</a></h2>
<p>Once trained, the Conditional Normalizing Flow (CNF) provides a <strong>smooth, differentiable mapping</strong> between stellar model input parameters <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> (e.g., mass, metallicity) and their corresponding observables <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> (e.g., <span class="math notranslate nohighlight">\(T_\mathrm{eff}\)</span>, <span class="math notranslate nohighlight">\(\log g\)</span>, radius). Combined with its generative capability, the CNF is a powerful tool for stellar parameter inference using sampling-based approaches.</p>
<section id="sampling-importance-resampling-sir">
<h3>Sampling/Importance Resampling (SIR)<a class="headerlink" href="#sampling-importance-resampling-sir" title="Permalink to this headline">#</a></h3>
<p>Using the CNF, we can perform <strong>Sampling/Importance Resampling (SIR)</strong>, a classical Bayesian technique, to approximate the posterior <span class="math notranslate nohighlight">\(p(\mathbf{x}|\mathbf{y}_\mathrm{obs})\)</span>.</p>
<blockquote>
<div><p>Given an observation <span class="math notranslate nohighlight">\(\mathbf{y}_\mathrm{obs}\)</span>, we would like to know what is its properties <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> based on our (emulated) grid of models.</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>Sample from the prior <span class="math notranslate nohighlight">\(p(\mathbf{x})\)</span>.</p></li>
<li><p>Map each sample <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> to predicted observables <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> using the CNF.</p></li>
<li><p>Weight each sample using a likelihood <span class="math notranslate nohighlight">\(\mathcal{L}(\mathbf{y}_\mathrm{obs} | \mathbf{y})\)</span>.</p></li>
<li><p>Resample according to these weights to approximate the posterior.</p></li>
</ol>
<p>This approach provides an intuitive analysis of how observed data shapes the inferred parameters.</p>
<div class="dropdown admonition">
<p class="admonition-title">For the Statistically-Minded</p>
<p>In Bayesian inference, we often seek to estimate the posterior distribution:</p>
<div class="math notranslate nohighlight">
\[
p(\phi \mid \text{data}) \propto \mathcal{L}(\phi) \, p(\phi),
\]</div>
<p>where <span class="math notranslate nohighlight">\(p(\phi)\)</span> is the prior and <span class="math notranslate nohighlight">\(\mathcal{L}(\phi)\)</span> is the likelihood of the observed data.</p>
<p><strong>Sampling/Importance Resampling (SIR)</strong> offers a way to approximate this distribution via the following steps:</p>
<ol class="arabic simple">
<li><p>Sample points <span class="math notranslate nohighlight">\(\phi_i\)</span> from a proposal distribution <span class="math notranslate nohighlight">\(g(\phi)\)</span> (e.g., the prior).</p></li>
<li><p>Compute importance weights:<br />
<span class="math notranslate nohighlight">\(
\omega_i = \frac{\mathcal{L}(\phi_i) \, p(\phi_i)}{g(\phi_i)}.
\)</span></p></li>
<li><p>Normalize the weights:<br />
<span class="math notranslate nohighlight">\(
q_i = \frac{\omega_i}{\sum_j \omega_j}.
\)</span></p></li>
<li><p>Resample: Draw <span class="math notranslate nohighlight">\(N\)</span> new samples from the <span class="math notranslate nohighlight">\(\phi_i\)</span> values according to the weights <span class="math notranslate nohighlight">\(q_i\)</span>.</p></li>
</ol>
<blockquote>
<div><p>In the special case where <span class="math notranslate nohighlight">\(g(\phi) = p(\phi)\)</span>, the importance weights simplify to:</p>
<p><span class="math notranslate nohighlight">\(q_i \propto \mathcal{L}(\phi_i)\)</span>.</p>
<p>That is, the posterior can be approximated by <strong>reweighting the prior samples using the likelihood</strong>.</p>
</div></blockquote>
<p>This is the core idea behind using CNFs for inference: draw from the prior, pass through the CNF to generate observables, compute likelihoods, and reweight to approximate the posterior.</p>
</div>
</section>
<section id="a-visual-example-of-sampling-importance-resampling-sir">
<h3>A Visual Example of Sampling/Importance Resampling (SIR)<a class="headerlink" href="#a-visual-example-of-sampling-importance-resampling-sir" title="Permalink to this headline">#</a></h3>
<p>In the following, we show how the SIR algorithm gives us an intuitive way of getting posterior samples by reweighting samples generated from the flow.</p>
<p>We first begin by generating samples from the prior. Here, we assume that both initial mass and metallicity are <strong>uniformly distributed</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_samps</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">mass_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_mass_subsampled</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_mass_subsampled</span><span class="p">),</span> <span class="n">num_samps</span><span class="p">)</span>
<span class="n">met_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_feh_subsampled</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_feh_subsampled</span><span class="p">),</span> <span class="n">num_samps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We then pass these samples through the normalizing flow:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cond_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_samps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>  <span class="c1"># shape of (N, num initial parameters)</span>
<span class="n">cond_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mass_range</span>  <span class="c1"># first column is for init mass</span>
<span class="n">cond_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">met_range</span> <span class="c1"># second column is for init met </span>
<span class="n">cond_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">cond_vec</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">flow_samples</span> <span class="o">=</span> <span class="n">flow</span><span class="p">(</span><span class="n">cond_vec</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="c1"># shape of (N, num output observables)</span>
</pre></div>
</div>
</div>
</div>
<p>The following code block <code class="docutils literal notranslate"><span class="pre">plot_prior</span></code> implements SIR as well as the plotting for the samples representing the prior and the observables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_prior</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">teff_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rad_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="c1">####### Sampling/Importance Resampling (SIR) ########</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="c1">## Prior Samples</span>
    
    
    <span class="n">pred_teff</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">teff_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  <span class="c1">## Observables</span>
    <span class="n">pred_rad</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">y</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pred_age</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">draw_prob_teff</span> <span class="o">=</span> <span class="n">draw_prob_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="c1">## Initializing Observable Vector</span>
    
    
    <span class="c1">#### Applying Constraints From Observable Vector Y Into Likelihoods ####</span>
    
    <span class="k">if</span> <span class="n">teff_constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">draw_prob_teff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">teff_constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>  <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span> <span class="n">pred_teff</span> <span class="o">-</span> <span class="n">teff_constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span> <span class="n">teff_constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>     
        
    <span class="k">if</span> <span class="n">rad_constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">draw_prob_rad</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">rad_constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>  <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span> <span class="n">pred_rad</span> <span class="o">-</span> <span class="n">rad_constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span> <span class="n">rad_constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>     
    
    <span class="n">draw_prob</span> <span class="o">=</span> <span class="n">draw_prob_teff</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="n">draw_prob_rad</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="c1"># Joint Likelihood</span>
    
    
    <span class="c1">#### Resampling X (prior) based on the Joint Likelihood ####</span>
    
    <span class="n">resampled_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
                                 <span class="n">weights</span><span class="o">=</span><span class="n">draw_prob</span> <span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">100000</span><span class="p">))</span>    
    
    
    
    <span class="c1">####### Plotting ########</span>
    
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;viridis&#39;</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">y</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">y</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prior Samples, $</span><span class="se">\\</span><span class="s1">mathbf</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">)</span>         
    <span class="n">im2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pred_teff</span><span class="p">,</span> 
                <span class="n">pred_rad</span><span class="p">,</span>
               <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">pred_age</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">teff_constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rad_constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">resampled_prior</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">resampled_prior</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                   <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Resampled Prior&#39;</span><span class="p">)</span>
        
        <span class="n">sc</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pred_teff</span><span class="p">[</span><span class="n">draw_prob</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">],</span> 
                    <span class="n">pred_rad</span><span class="p">[</span><span class="n">draw_prob</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">],</span>
                   <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">draw_prob</span><span class="p">[</span><span class="n">draw_prob</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">]),</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">999</span><span class="p">)</span>
        
        <span class="n">cax</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> 
                 <span class="n">width</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span><span class="p">,</span>  
                 <span class="n">height</span><span class="o">=</span><span class="s2">&quot;3%&quot;</span><span class="p">,</span> 
                 <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span>
                 <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                 <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                 <span class="n">borderpad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;log-likelihood&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
         
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">fs</span><span class="p">},</span> <span class="n">framealpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Initial Mass ($M_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Initial [Fe/H] (dex)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">6500</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.8</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$T_{</span><span class="se">\\</span><span class="s1">mathrm</span><span class="si">{eff}</span><span class="s1">}$ (K)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Radius ($R_{</span><span class="se">\\</span><span class="s1">odot}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    
    <span class="n">sm</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.1265</span><span class="p">,</span> <span class="mf">0.89</span><span class="p">,</span> <span class="mf">0.7735</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span> 
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Model Age (Gyr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>First, we visualize the prior, <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>, on the left and the corresponding observable distribution <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> on the right. These are <strong>samples from the flow</strong> and are colored by age – notice how samples of a specific initial mass and metallicity in the prior occupy specific regions in the observable space!</p>
<p>This occurs because the flow provides a <strong>one-to-one mapping</strong> between <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>, enabling us to push forward the prior into observable space and evaluate likelihoods directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_prior</span><span class="p">(</span><span class="n">flow_samples</span><span class="p">,</span> <span class="n">cond_vec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/09a1b6442d5ebe8b215d223ff8f0b8d7cd287760d72ed5c759304d641912a0b7.png" src="../_images/09a1b6442d5ebe8b215d223ff8f0b8d7cd287760d72ed5c759304d641912a0b7.png" />
</div>
</div>
<p>Next, we visualize the prior samples after applying a Gaussian likelihood <span class="math notranslate nohighlight">\(T_{\mathrm{eff}}\)</span> constraint to the <span class="math notranslate nohighlight">\(T_{\mathrm{eff}}-R\)</span> space:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_prior</span><span class="p">(</span><span class="n">flow_samples</span><span class="p">,</span> <span class="n">cond_vec</span><span class="p">,</span> <span class="n">teff_constraint</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4500</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6c34203b112f45815b7a5806162fbeaf1e906baab14b84918cea3b0b780ac55d.png" src="../_images/6c34203b112f45815b7a5806162fbeaf1e906baab14b84918cea3b0b780ac55d.png" />
</div>
</div>
<p>Note the reduction in the prior space occupied by the samples – this is because they have been <strong>resampled with weights following the likelihood</strong> from the observed space.</p>
<p>We now further add on a constraint in radius:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_prior</span><span class="p">(</span><span class="n">flow_samples</span><span class="p">,</span> <span class="n">cond_vec</span><span class="p">,</span> <span class="n">teff_constraint</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4500</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">rad_constraint</span> <span class="o">=</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fca61b67258a019e95b730fbd19162fb01dbb3df5ae03a6497dedc00bf169310.png" src="../_images/fca61b67258a019e95b730fbd19162fb01dbb3df5ae03a6497dedc00bf169310.png" />
</div>
</div>
<p>The region occupied in the prior space shrinks correspondingly. The remaining samples is approximately distributed according to the posterior distribution.</p>
<div class="note admonition">
<p class="admonition-title">Duality of Constraints</p>
<p>In the above example, we have limited samples from the flow by applying constraints to the observables <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> through Gaussian likelihoods.</p>
<ol class="arabic simple">
<li><p>Can we perform the converse, which is to directly manipulate <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> to change the distribution of
<span class="math notranslate nohighlight">\(\mathbf{y}\)</span> sampled from the flow?</p></li>
</ol>
<ul class="simple">
<li><p>Which part of the code needs to be altered to do this?</p></li>
<li><p>Under what circumstances would we need to do this?</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>From the one-to-one correspondence of the prior <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> with the observables <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>, describe conceptually on how stellar ages are determined from the observed properties of a star using sampling-based approaches on a grid of models.</p></li>
</ol>
</div>
</section>
</section>
<section id="see-also">
<h2>See Also:<a class="headerlink" href="#see-also" title="Permalink to this headline">#</a></h2>
<p><a class="reference external" href="https://observablehq.com/&#64;herbps10/importance-sampling">Visualization on Importance Sampling</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2024ApJ...973..154H/abstract">Flow-based Generative Emulation of Grids of Stellar Evolutionary Models</a></p>
<p>The <a class="reference external" href="https://github.com/mtyhon/modelflows"><code class="docutils literal notranslate"><span class="pre">modelflows</span></code></a> library</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapter3"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tabular-1.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Grids of Stellar Models Part 1: <em>Stellar Parameter Regression</em></p>
      </div>
    </a>
    <a class="right-next"
       href="tabular-3.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Catalogue Data Part 1: <em>Mixed Data Types</em></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#isochrones-and-evolutionary-phases">Isochrones and Evolutionary Phases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-parameters-mathbf-y">Input Parameters, <span class="math notranslate nohighlight">\(\mathbf{y}\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-observable-parameters-mathbf-x">Output Observable Parameters, <span class="math notranslate nohighlight">\(\mathbf{x}\)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-curse-of-dimensionality">The Curse of Dimensionality</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-discrepancy-metric">The Discrepancy Metric</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-interpolation-using-eeps">Linear Interpolation using EEPs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#beyond-linear-interpolation-emulation">Beyond Linear Interpolation: Emulation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#emulating-stellar-grids-with-neural-networks">Emulating Stellar Grids with Neural Networks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#normalizing-flows-as-a-grid-emulator">Normalizing Flows as a Grid Emulator</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-emulated-distribution-from-the-trained-flow">Visualizing the Emulated Distribution from the Trained Flow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scenario-1-emulating-an-individual-track">Scenario 1: Emulating an individual track</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scenario-2-emulating-a-continuum-of-tracks">Scenario 2: Emulating a continuum of tracks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flow-based-stellar-parameter-inference-sampling-importance-resampling">Flow-based Stellar Parameter Inference: Sampling-Importance Resampling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-importance-resampling-sir">Sampling/Importance Resampling (SIR)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-visual-example-of-sampling-importance-resampling-sir">A Visual Example of Sampling/Importance Resampling (SIR)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#see-also">See Also:</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Marc Hon
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>