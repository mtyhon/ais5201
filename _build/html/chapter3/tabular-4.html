

<!DOCTYPE html>


<html data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Catalogue Data Part 2: Finding Clusters and Overdensities &#8212; AIS 5201: AI In Astrophysics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapter3/tabular-4';</script>
    <link rel="canonical" href="https://USER.github.io/REPO/chapter3/tabular-4.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Physics Informed Neural Network" href="tabular-5.html" />
    <link rel="prev" title="Catalogue Data Part 1: Mixed Data Types" href="tabular-3.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">AIS 5201: AI In Astrophysics</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction to AIS 5201
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter1/section_intro.html">Time-domain Data</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/fitting_power_spectrum_1.html">Fitting Red Giant Oscillations Part 1: <em>Traditional Optimization</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/fitting_power_spectrum_2.html">Fitting Red Giant Oscillations Part 2: <em>Flows &amp; Simulation-Based Inference</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/ps_statistics.html"><em>Power Spectrum Statistics</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/eb-morphology_1.html">Eclipse Morphology Part 1: <em>Exploring and Preparing Data</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/eb-morphology_2.html">Eclipse Morphology Part 2: <em>Low-Dimensional Representations</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/eb-morphology_3.html">Eclipse Morphology Part 3: <em>Latent Spaces and Visualizing Them</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/eb-morphology_4.html">Eclipse Morphology Part 4: <em>The Variational Autoencoder</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/transit-1.html">Planetary Transits Part 1: <em>Observing Transits</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/transit-2.html">Planetary Transits Part 2: <em>Classifying Transits</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter1/transit-3.html">Planetary Transits Part 3: <em>Fitting a Transit Profile</em></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter2/section_intro.html">Spectra</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/sed-1.html">Spectral Energy Distribution (SED) Part 1: <em>Observing SEDs</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/sed-2.html">Spectral Energy Distribution (SED) Part 2: <em>Fitting SEDs</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/sed-3.html">Spectral Energy Distribution (SED) Part 3: <em>Bayesian Evidence and Model Selection</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-1.html">Stellar Spectra Part 1: <em>Observing Detailed Spectral Features</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-2.html">Stellar Spectra Part 2: <em>The Cannon</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-3.html">Stellar Spectra Part 3: <em>The Payne</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-4.html">Stellar Spectra Part 4: <em>Detecting Stellar Activity Indicators</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter2/spectra-5.html">Stellar Spectra Part 5: <em>Domain Transfer</em></a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="section_intro.html">Tabular Data</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tabular-1.html">Grids of Stellar Models Part 1: <em>Stellar Parameter Regression</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="tabular-2.html">Grids of Stellar Models Part 2: <em>Interpolation</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="tabular-3.html">Catalogue Data Part 1: <em>Mixed Data Types</em></a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Catalogue Data Part 2: <em>Finding Clusters and Overdensities</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="tabular-5.html"><em>The Physics Informed Neural Network</em></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter4/section_intro.html">Images</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter4/images-1.html">Images Part 1: <em>Galaxy Merger Classification</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter4/images-2.html">Images Part 2: <em>Galaxy Morphology Classification</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter4/images-3.html">Images Part 3: <em>Self-Supervised Learning</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter4/images-4.html">Images Part 4: <em>Upscaling the Cosmic Web</em></a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/executablebooks/jupyter-book/blob/master/docs/chapter3/tabular-4.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/edit/master/docs/chapter3/tabular-4.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fchapter3/tabular-4.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/chapter3/tabular-4.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Catalogue Data Part 2: Finding Clusters and Overdensities</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#star-clusters">Star Clusters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-overdensities">Clustering Overdensities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-aggregation-process">The Aggregation Process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#connection-with-neural-density-estimation">Connection with Neural Density Estimation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#density-estimation-with-the-flow">Density Estimation with the Flow</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-stellar-streams">Clustering Stellar Streams</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-in-velocity-space">Clustering in Velocity Space</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-in-integral-of-motion-iom-space">Clustering in Integral of Motion (IoM) Space</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#see-also">See also</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="catalogue-data-part-2-finding-clusters-and-overdensities">
<span id="content-references-tabular-part4"></span><h1>Catalogue Data Part 2: <em>Finding Clusters and Overdensities</em><a class="headerlink" href="#catalogue-data-part-2-finding-clusters-and-overdensities" title="Permalink to this headline">#</a></h1>
<p><em><strong>Author: Marc Hon (<a class="reference external" href="mailto:mtyhon&#37;&#52;&#48;nus&#46;edu&#46;sg">mtyhon<span>&#64;</span>nus<span>&#46;</span>edu<span>&#46;</span>sg</a>), Earl Patrick Bellinger (<a class="reference external" href="mailto:earl&#46;bellinger&#37;&#52;&#48;yale&#46;edu">earl<span>&#46;</span>bellinger<span>&#64;</span>yale<span>&#46;</span>edu</a>)</strong></em></p>
<p>Machine learning techniques are particularly valuable in the data mining of kinematic information of stars in the Milky Way. A major contributor to this information over the past decade is the <a class="reference external" href="https://www.esa.int/Science_Exploration/Space_Science/Gaia"><strong><em>Gaia</em> mission</strong></a>. <em>Gaia</em> is a space observatory that was launched by the European Space Agency (ESA) in December 2013 with the objective of creating a precise three-dimensional map of our Milky Way Galaxy by measuring the positions, distances, and motions of over a billion stars. The mission officially ended its science observations at the beginning of 2025.</p>
<section id="star-clusters">
<h2>Star Clusters<a class="headerlink" href="#star-clusters" title="Permalink to this headline">#</a></h2>
<p>A key task in Galactic astronomy is the identification of <strong>star clusters</strong>—gravitationally bound groups of stars that likely formed together from the same molecular cloud. These clusters can be broadly classified into two types:</p>
<ol class="arabic simple">
<li><p><strong>Open Clusters</strong> – These are loosely bound groups containing a few dozen to several thousand relatively young stars. Open clusters are typically located in the spiral arms of galaxies like the Milky Way. Over time, they can disperse due to internal dynamics and external tidal forces.</p></li>
<li><p><strong>Globular Clusters</strong> –  These are densely packed, roughly spherical systems containing hundreds of thousands to millions of old stars. They are found primarily in the halos of galaxies. Many are thought to be the remnant cores of dwarf galaxies that were stripped of their outer stars through gravitational interactions with more massive systems like the Milky Way, leaving behind a compact stellar nucleus.</p></li>
</ol>
<p>To find these clusters, <strong>overdensities</strong> are identified in kinematic space. Let’s load a dataset that examines this.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scienceplots</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mticker</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.cm</span> <span class="kn">import</span> <span class="n">ScalarMappable</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">BoundaryNorm</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">coordinates</span> <span class="k">as</span> <span class="n">coords</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">inset_axes</span><span class="p">,</span> <span class="n">mark_inset</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;science&#39;</span><span class="p">);</span> <span class="n">fs</span><span class="o">=</span><span class="mi">15</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">data_folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;ml_astro&#39;</span> <span class="o">/</span> <span class="s1">&#39;chapter3&#39;</span> <span class="o">/</span> <span class="s1">&#39;data&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gaia</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data_folder_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/gaia.parquet&#39;</span><span class="p">);</span> <span class="n">gaia</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SOURCE_ID</th>
      <th>ra</th>
      <th>dec</th>
      <th>parallax</th>
      <th>parallax_error</th>
      <th>pmra</th>
      <th>pmdec</th>
      <th>phot_g_mean_mag</th>
      <th>phot_bp_mean_mag</th>
      <th>phot_rp_mean_mag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>65583742591605248</td>
      <td>58.344770</td>
      <td>22.688222</td>
      <td>1.773985</td>
      <td>0.118453</td>
      <td>-2.811473</td>
      <td>-6.346291</td>
      <td>17.609467</td>
      <td>18.786692</td>
      <td>16.543457</td>
    </tr>
    <tr>
      <th>1</th>
      <td>65583875733141632</td>
      <td>58.365304</td>
      <td>22.711922</td>
      <td>0.622843</td>
      <td>0.121425</td>
      <td>3.985970</td>
      <td>-0.217382</td>
      <td>17.743832</td>
      <td>18.560629</td>
      <td>16.845654</td>
    </tr>
    <tr>
      <th>2</th>
      <td>65583914390253056</td>
      <td>58.383565</td>
      <td>22.714186</td>
      <td>0.421515</td>
      <td>0.067883</td>
      <td>1.139664</td>
      <td>-3.740360</td>
      <td>16.544357</td>
      <td>17.014826</td>
      <td>15.913900</td>
    </tr>
    <tr>
      <th>3</th>
      <td>65583948747956608</td>
      <td>58.340348</td>
      <td>22.701516</td>
      <td>2.490116</td>
      <td>0.274591</td>
      <td>2.819814</td>
      <td>-0.457338</td>
      <td>19.026190</td>
      <td>20.643658</td>
      <td>17.811607</td>
    </tr>
    <tr>
      <th>4</th>
      <td>65583948749993216</td>
      <td>58.341225</td>
      <td>22.695062</td>
      <td>4.679934</td>
      <td>0.018546</td>
      <td>20.197302</td>
      <td>-35.987244</td>
      <td>13.692286</td>
      <td>14.414783</td>
      <td>12.862484</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>23593</th>
      <td>70229278000208768</td>
      <td>56.246897</td>
      <td>26.029548</td>
      <td>1.073663</td>
      <td>0.146265</td>
      <td>4.603285</td>
      <td>-14.751901</td>
      <td>18.036743</td>
      <td>19.125248</td>
      <td>17.048775</td>
    </tr>
    <tr>
      <th>23594</th>
      <td>70368748476458240</td>
      <td>57.661793</td>
      <td>25.955714</td>
      <td>4.020031</td>
      <td>0.506745</td>
      <td>27.559650</td>
      <td>-17.419874</td>
      <td>19.876314</td>
      <td>20.031540</td>
      <td>19.577700</td>
    </tr>
    <tr>
      <th>23595</th>
      <td>70368778537406976</td>
      <td>57.670013</td>
      <td>25.961820</td>
      <td>2.125805</td>
      <td>0.015136</td>
      <td>21.125963</td>
      <td>-8.930315</td>
      <td>12.476719</td>
      <td>13.043477</td>
      <td>11.763743</td>
    </tr>
    <tr>
      <th>23596</th>
      <td>70368817195934720</td>
      <td>57.643223</td>
      <td>25.970933</td>
      <td>0.927687</td>
      <td>0.048298</td>
      <td>4.152684</td>
      <td>0.594143</td>
      <td>16.208418</td>
      <td>16.743715</td>
      <td>15.522631</td>
    </tr>
    <tr>
      <th>23597</th>
      <td>70369092073841536</td>
      <td>57.621947</td>
      <td>25.982217</td>
      <td>0.602164</td>
      <td>0.111355</td>
      <td>5.896885</td>
      <td>-1.911030</td>
      <td>17.721956</td>
      <td>18.327131</td>
      <td>16.977314</td>
    </tr>
  </tbody>
</table>
<p>23598 rows × 10 columns</p>
</div></div></div>
</div>
<p>The DataFrame has the following columns:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Column</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SOURCE_ID</span></code></p></td>
<td><p>Unique Gaia source identifier.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ra</span></code></p></td>
<td><p>Right ascension (degrees), celestial longitude on the sky.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">dec</span></code></p></td>
<td><p>Declination (degrees), celestial latitude on the sky.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">parallax</span></code></p></td>
<td><p>Parallax (mas), inverse of distance: <span class="math notranslate nohighlight">\( d\ [\mathrm{pc}] = 1000 / \varpi \)</span>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">parallax_error</span></code></p></td>
<td><p>Uncertainty in parallax (mas); large fractional errors imply poor distances.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">pmra</span></code></p></td>
<td><p>Proper motion in RA × cos(dec) (mas/yr), east–west angular motion.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pmdec</span></code></p></td>
<td><p>Proper motion in Dec (mas/yr), north–south angular motion.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">phot_g_mean_mag</span></code></p></td>
<td><p>Mean Gaia G-band magnitude (broad optical).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">phot_bp_mean_mag</span></code></p></td>
<td><p>Mean BP-band magnitude (~330–680 nm).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">phot_rp_mean_mag</span></code></p></td>
<td><p>Mean RP-band magnitude (~630–1050 nm).</p></td>
</tr>
</tbody>
</table>
<div class="info admonition">
<p class="admonition-title">Querying the <em>Gaia</em> Archive</p>
<p>Measurements from the <em>Gaia</em> mission can be publicly accessed from the <a class="reference external" href="https://gea.esac.esa.int/archive/">ESA Gaia Archive</a>. Querying the archive efficiently relies on the use of an SQL-like language known as the <strong>Astronomical Data Query Language (ADQL)</strong>. Queries written in ADQL can be used directly in the online portal, though it can be used programmatically in Python. The following code snippet shows the query to obtain the dataset (<code class="docutils literal notranslate"><span class="pre">results</span></code>) used in the first part of this notebook, which is then converted into a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astroquery.gaia</span> <span class="kn">import</span> <span class="n">Gaia</span>

<span class="n">adql_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT</span>
<span class="s2">      g.source_id, g.ra, g.dec, </span>
<span class="s2">      g.parallax, g.parallax_error, </span>
<span class="s2">      g.pmra, g.pmdec,</span>
<span class="s2">      g.phot_g_mean_mag, g.phot_bp_mean_mag, g.phot_rp_mean_mag</span>
<span class="s2">    FROM gaiadr3.gaia_source AS g</span>
<span class="s2">    WHERE CONTAINS(</span>
<span class="s2">        POINT(&#39;ICRS&#39;, g.ra, g.dec),</span>
<span class="s2">        CIRCLE(&#39;ICRS&#39;, 57, 24, 2)</span>
<span class="s2">      ) = 1</span>
<span class="s2">    AND g.phot_bp_mean_mag IS NOT NULL</span>
<span class="s2">    AND g.phot_rp_mean_mag IS NOT NULL</span>
<span class="s2">    AND g.astrometric_params_solved = 31</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">job</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">launch_job_async</span><span class="p">(</span><span class="n">adql_query</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Here, we are looking at a patch of sky of radius 2<span class="math notranslate nohighlight">\(^{\circ}\)</span> centered at (RA, Dec) = (57<span class="math notranslate nohighlight">\(^{\circ}\)</span>,24<span class="math notranslate nohighlight">\(^{\circ}\)</span>). Colour-coding by parallaxes, we observe nothing immediately distinct within the field. However, by analyzing the proper motion of this field of stars, we find a particularly interesting overdensity at about (<span class="math notranslate nohighlight">\(\mu_{\alpha*}\)</span>, <span class="math notranslate nohighlight">\(\mu_{\delta}\)</span>) <span class="math notranslate nohighlight">\(\sim\)</span> (20, -45) mas/yr. Not only does this clump of stars have very similar proper motion (i.e., moving together in space), they have very similar parallaxes, meaning that their distances from the Sun are nearly identical.</p>
<p>To single out this agglomeration, we turn to <strong>clustering algorithms</strong>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">sc1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;parallax&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">cb1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Parallax (mas)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Right Ascension ($^\circ$) &quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Declination ($^\circ$)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Circular Patch of Sky&quot;</span><span class="p">)</span>

<span class="n">sc2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">],</span> <span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;parallax&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">999</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">999</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
<span class="n">cb2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Parallax (mas)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_{\alpha*}$ (mas/yr)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_{\delta}$ (mas/yr)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Proper Motion&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/0641a5c38da5059e8a90fec176f115f1c8dd838f0929efa1fcbeba910f918ff4.png" src="../_images/0641a5c38da5059e8a90fec176f115f1c8dd838f0929efa1fcbeba910f918ff4.png" />
</div>
</div>
</section>
<section id="clustering-overdensities">
<h2>Clustering Overdensities<a class="headerlink" href="#clustering-overdensities" title="Permalink to this headline">#</a></h2>
<p>While a variety of clustering algorithms exists (e.g., K-Means, Spectral Clustering, HDBSCAN, FOPTICS, see <a class="reference external" href="https://scikit-learn.org/stable/modules/clustering.html">here</a>), we will use the novel approach <a class="reference external" href="https://github.com/william-h-oliver/astrolink/tree/main">AstroLink</a> – a method specifically designed for hierarchical clustering in astrophysical datasets, which can be noisy and have structure across varying scales.</p>
<p>To see this in action, let’s import the library and prepare the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astrolink</span> <span class="kn">import</span> <span class="n">AstroLink</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">RobustScaler</span>

<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;parallax&#39;</span><span class="p">,</span> <span class="s1">&#39;pmra&#39;</span><span class="p">,</span> <span class="s1">&#39;pmdec&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gaia</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
<span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, let’s run the clustering algorithm on the data. We will use the positions, motion, and parallaxes of the stars as our input features.</p>
<div class="tip admonition">
<p class="admonition-title">Scaling Features</p>
<p>The scaling of input features with <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>’s <code class="docutils literal notranslate"><span class="pre">RobustScaler</span></code> is particularly helpful when dealing with kinematic data. This scaling approach scales features by their median and interquartile range, and not only removes disparate scales from the data, but is less sensitive to strong outliers – a common occurrence in large datasets such as from <em>Gaia</em>.</p>
<p>Note that by default, <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> already scales features to have unit variance through its <code class="docutils literal notranslate"><span class="pre">adaptive</span></code> argument at initialization.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusterer</span> <span class="o">=</span> <span class="n">AstroLink</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">clusterer</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ords</span> <span class="o">=</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">ordering</span>
<span class="n">ord_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ords</span><span class="p">]</span>

<span class="n">color_</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;phot_bp_mean_mag&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;phot_rp_mean_mag&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ords</span><span class="p">]</span>
<span class="n">magnitude_</span> <span class="o">=</span> <span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;phot_g_mean_mag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ords</span><span class="p">]</span>
<span class="n">pmra_</span> <span class="o">=</span> <span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ords</span><span class="p">]</span>
<span class="n">pmdec_</span> <span class="o">=</span> <span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ords</span><span class="p">]</span>

<span class="n">nclusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># First Cluster is the Global Tree</span>
<span class="n">_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;bwr&#39;</span><span class="p">]</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">_cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nclusters</span><span class="p">)))</span>
<span class="n">norm_</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">boundaries</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">nclusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncolors</span><span class="o">=</span><span class="n">nclusters</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
<span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>

<span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ord_data</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">ord_data</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">ord_data</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma_r&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ord_data</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">ord_data</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">color_</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">magnitude_</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">ord_data</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma_r&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">color_</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">magnitude_</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">clust</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># First Cluster is the Global Tree</span>
        <span class="k">continue</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ord_data</span><span class="p">[</span><span class="n">clust</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">clust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">ord_data</span><span class="p">[</span><span class="n">clust</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">clust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm_</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
               <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">color_</span><span class="p">[</span><span class="n">clust</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">clust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">magnitude_</span><span class="p">[</span><span class="n">clust</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">clust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm_</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
               <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_{\alpha*}$ (mas/yr)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_{\delta}$ (mas/yr)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;Proper Motion&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
    
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;BP $-$ RP (mag)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;G (mag)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;Color-Magnitude Diagram&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

<span class="n">boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nclusters</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> 
<span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="n">nclusters</span><span class="p">)</span>
<span class="n">tick_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">nclusters</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span>

<span class="n">sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

<span class="n">cbar1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Parallax (mas)&quot;</span><span class="p">)</span>
<span class="n">cbar2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">tick_positions</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="n">boundaries</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">)</span>
<span class="n">cbar2</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nclusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
<span class="n">cbar2</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Cluster Number&quot;</span><span class="p">)</span>
<span class="n">cbar3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Parallax (mas)&quot;</span><span class="p">)</span>
<span class="n">cbar4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">tick_positions</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="n">boundaries</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">)</span>
<span class="n">cbar4</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nclusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
<span class="n">cbar4</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Cluster Number&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/8a778c1e92a0f7acf227d04ec39088a940bef2b221c0f491e800aaf1a4697054.png" src="../_images/8a778c1e92a0f7acf227d04ec39088a940bef2b221c0f491e800aaf1a4697054.png" />
</div>
</div>
<p>We find that the clustering algorithm identifies two groups: the first being overdensity in proper motion identified earlier, while the second is simply other background stars in the field. In the bottom panels above, the overdensity indeed corresponds to a very specific sequence of stars along in the color-magnitude diagram! This is no coincidence, for these are main sequence stars belonging to the young open cluster <strong>Melotte 22</strong>, though it is much more famously known by another name.</p>
<p>Let’s examine how the clustering algorithm works.</p>
</section>
<section id="the-aggregation-process">
<h2>The Aggregation Process<a class="headerlink" href="#the-aggregation-process" title="Permalink to this headline">#</a></h2>
<p>Clustering algorithms generally operate by grouping points that exhibit <strong>strong similarity or affinity</strong>, though the way similarity is defined and measured varies significantly between methods.</p>
<p>The core working of <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> is the following:</p>
<blockquote>
<div><p>Merge data points into clusters by following strong, high-density connections, while recording how distinct each cluster’s <strong>prominence</strong>.</p>
</div></blockquote>
<p>The aggregation steps, also outlined <a class="reference external" href="https://astrolink.readthedocs.io/en/latest/howitworks.html">here</a>, are as follows:</p>
<p><strong>Density Estimation:</strong> Each point is assigned a <code class="docutils literal notranslate"><span class="pre">logRho</span></code> value that represents its local density. The value is estimated based on a kernel function of each point’s <code class="docutils literal notranslate"><span class="pre">k_den</span></code> nearest neighbours. A higher <code class="docutils literal notranslate"><span class="pre">logRho</span></code> corresponds to denser regions.
<strong>Nearest Neighbour Connection:</strong> <code class="docutils literal notranslate"><span class="pre">k_link</span></code> nearest neighbors are found for each point, and edges between the neighbours are created. The <strong>weight</strong> or strength of each connection is determined as min(<code class="docutils literal notranslate"><span class="pre">logRho[i]</span></code>, <code class="docutils literal notranslate"><span class="pre">logRho[j]</span></code>).
<strong>Sort Edges by Strength:</strong> Sort all edges in <strong>descending</strong> order of weight. This is done within the vicinity of each neighbourhood, and creates ordered lists locally.
<strong>Merge Points into Clusters:</strong> In each neighbourhood, traverse edges in order:</p>
<ul class="simple">
<li><p>If neither point is assigned → create new ordered list</p></li>
<li><p>If one point is in an ordered list → add the other</p></li>
<li><p>If both are in different lists → merge them into a group.</p></li>
</ul>
<p>The group tracks the hierarchical merging of lists and is illustrated in the following example:</p>
<figure class="align-default" id="astrolink">
<a class="reference internal image-reference" href="../_images/astrolink.png"><img alt="../_images/astrolink.png" src="../_images/astrolink.png" style="width: 800px; height: 500px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 35 </span><span class="caption-text">Sequential schematic of the <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> aggregation process. The process begins by the sorting of edges (<span class="math notranslate nohighlight">\(E\)</span>) by decreasing density to form ordered lists (<span class="math notranslate nohighlight">\(O\)</span>) locally, and the hierarchical merging of ordered lists to form groups (<span class="math notranslate nohighlight">\(G\)</span>).
Image adapted from <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2024MNRAS.530.2637O/abstract">Oliver et al. (2024)</a>.</span><a class="headerlink" href="#astrolink" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>At this stage, it is worth visualizing how this corresponds to the clustering of our <em>Gaia</em> dataset.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cluster_thresholds</span><span class="p">(</span><span class="n">clusterer</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">ords</span> <span class="o">=</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">ordering</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">thresh_cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">logRho</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
    
    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">ords</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">ords</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">clusterer</span><span class="o">.</span><span class="n">logRho</span><span class="p">[</span><span class="n">ords</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">thresh_cond</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">thresh_cond</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_{\alpha*}$ (mas/yr)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_{\delta}$ (mas/yr)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;Proper Motion&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>


    <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Normalized $</span><span class="se">\\</span><span class="s1">log </span><span class="se">\\</span><span class="s1">rho$&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">n_samples</span><span class="p">),</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">logRho</span><span class="p">[</span><span class="n">ords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">n_samples</span><span class="p">)))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Ordered Index&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized $</span><span class="se">\\</span><span class="s1">log </span><span class="se">\\</span><span class="s1">rho$&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

    <span class="n">logRho_ordered</span> <span class="o">=</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">logRho</span><span class="p">[</span><span class="n">clusterer</span><span class="o">.</span><span class="n">ordering</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">clst</span><span class="p">,</span> <span class="n">clst_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">ids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">clst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ord_dens_clst</span> <span class="o">=</span> <span class="n">logRho_ordered</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    
            <span class="n">mask</span> <span class="o">=</span> <span class="n">ord_dens_clst</span> <span class="o">&gt;</span> <span class="n">thresh</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">x_masked</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">y_masked</span> <span class="o">=</span> <span class="n">ord_dens_clst</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_masked</span><span class="p">,</span> <span class="n">y_masked</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">cluster_thresholds</span><span class="p">(</span><span class="n">clusterer</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/dfcc4907acec5f67ca1271454e8884df8896179c95a5890bba894010c5cd0504.png" src="../_images/dfcc4907acec5f67ca1271454e8884df8896179c95a5890bba894010c5cd0504.png" />
</div>
</div>
<p>Above, the proper motion of the stars are coloured according to the calculated log density, revealing that the most dense regions are near the origin (low observed motion) and the overdensity corresponding to <strong>Melotte 22</strong>. Adjusting the value of <code class="docutils literal notranslate"><span class="pre">thresh</span></code> selects <strong>only stars above a certain density threshold</strong>, with the greater the number of stars above the threshold, the larger the cluster.</p>
<div class="note admonition">
<p class="admonition-title">Understanding the Merging</p>
<p>Adjust the value of <code class="docutils literal notranslate"><span class="pre">thresh</span></code> above. At what stage does the central cluster connect to the overdensity represented by <strong>Melotte 22</strong>? What feature in the <span class="math notranslate nohighlight">\(\log\rho\)</span>-index curve does this correspond to?</p>
</div>
<p>The final step of the <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> algorithm is to calculate <strong>prominences</strong> and <strong>significances</strong>.</p>
<p>Each group’s prominence <span class="math notranslate nohighlight">\(P_g\)</span> is computed as:</p>
<div class="math notranslate nohighlight">
\[
P_g = \log \hat{\rho}_{\text{max}, g} - \log \hat{\rho}_{\text{boundary}, g} - \log \hat{\rho}_{\text{noise}, g}
\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\( \log \hat{\rho}_{\text{max}, g} \)</span>: peak density within the group</p></li>
<li><p><span class="math notranslate nohighlight">\( \log \hat{\rho}_{\text{boundary}, g} \)</span>: saddle density where the group merges into another</p></li>
<li><p><span class="math notranslate nohighlight">\( \log \hat{\rho}_{\text{noise}, g} \)</span>: correction for intra-group noise</p></li>
</ul>
<p>Prominences are transformed into a <em>significance score</em> using a fitted Beta–Uniform mixture model:</p>
<ul class="simple">
<li><p>A <strong>Beta distribution</strong> models noise-like groups (low prominence)</p></li>
<li><p>A <strong>Uniform tail</strong> models real clusters (high prominence)</p></li>
<li><p>The <strong>cutoff</strong> point <span class="math notranslate nohighlight">\(c\)</span> separates noise from clusters and ensures continuity</p></li>
</ul>
<p>The following image demonstrates these on a toy example.</p>
<figure class="align-default" id="astro-prominences">
<a class="reference internal image-reference" href="../_images/astro_prominences.png"><img alt="../_images/astro_prominences.png" src="../_images/astro_prominences.png" style="width: 500px; height: 300px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 36 </span><span class="caption-text">Depiction of prominences and significances from  <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> on a toy dataset, adopted from Fig. 5 of <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2024MNRAS.530.2637O/abstract">Oliver et al. (2024)</a>.</span><a class="headerlink" href="#astro-prominences" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The final outputs of the algorithm are the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ordering</span></code>: data points listed in merge order</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">groups</span></code>: index ranges of each cluster in <code class="docutils literal notranslate"><span class="pre">ordering</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prominences</span></code> and <code class="docutils literal notranslate"><span class="pre">significances</span></code>: density-based prominences/significance of each cluster</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">Exercise</p>
<p>Within the original field of stars, <strong>Melotte 22</strong> spatially did not appear strongly clustered as opposed to viewing its proper motion. Verify that it can still be clustered when RA and Declination are not included as features in the clustering.</p>
</div>
</section>
<section id="connection-with-neural-density-estimation">
<h2>Connection with Neural Density Estimation<a class="headerlink" href="#connection-with-neural-density-estimation" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> relies on an estimate of <strong>density</strong>, <span class="math notranslate nohighlight">\(\log\rho\)</span> calculated from distances to nearest neighbours. This captures how tightly packed points are in a small region of space. Similarly, normalizing flows estimate the global probability density <span class="math notranslate nohighlight">\(\log p(x)\)</span>, assigning higher log-probability to regions where data points are more concentrated.</p>
<p>In the following, a Neural Spline Flow normalizing flow is trained to model the density of the <em>Gaia</em> dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">zuko</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">scaled_data</span>
<span class="n">X_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">X_tensor</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_tensor</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">10.</span> <span class="c1"># transforming to make the scales more comparable</span>
<span class="n">X_tensor</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_tensor</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">10.</span>
<span class="n">X_tensor</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_tensor</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="mf">10.</span> 

<span class="n">X_dataset</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">X_tensor</span><span class="p">)</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">X_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Neural spline flow (NSF) with 5 sample features, 0 conditional features</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">zuko</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">NSF</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">hidden_features</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">20</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="n">tot_loss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">flow</span><span class="p">()</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># -log p(x)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">tot_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">, Loss: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tot_loss</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 0, Loss: -0.4002267703777406
Epoch 1, Loss: -1.5479340125228653
Epoch 2, Loss: -1.675556653075748
Epoch 3, Loss: -1.736020929283566
Epoch 4, Loss: -1.8236955186215842
Epoch 5, Loss: -1.9042016991431796
Epoch 6, Loss: -1.9086713949193153
Epoch 7, Loss: -1.9466577362884998
Epoch 8, Loss: -1.9518855249655602
Epoch 9, Loss: -1.9584463178949951
Epoch 10, Loss: -1.9592240372001317
Epoch 11, Loss: -1.976104675108178
Epoch 12, Loss: -1.9943319397567087
Epoch 13, Loss: -1.9958365696878615
Epoch 14, Loss: -2.005933244376971
Epoch 15, Loss: -2.0063102466627187
Epoch 16, Loss: -2.0153118391347125
Epoch 17, Loss: -2.023337807758714
Epoch 18, Loss: -2.0275023159618946
Epoch 19, Loss: -2.0442777371341943
</pre></div>
</div>
</div>
</div>
<p>Despite limited training, the flow performs reasonably at approximating the distribution of stars in the dataset, as seen below for the proper motion.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samps</span> <span class="o">=</span> <span class="n">flow</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">([</span><span class="mi">10000</span><span class="p">])</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">samps</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">samps</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span> <span class="mf">10.</span>  <span class="c1"># reversing the transformation</span>
<span class="n">samps</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">samps</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span> <span class="mf">10.</span>
<span class="n">samps</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">samps</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span> <span class="mf">10.</span>
<span class="n">samps</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">samps</span><span class="p">)</span>

<span class="n">tens</span> <span class="o">=</span> <span class="n">X_tensor</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tens</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tens</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span> <span class="mf">10.</span>  <span class="c1"># reversing the transformation</span>
<span class="n">tens</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tens</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span> <span class="mf">10.</span>
<span class="n">tens</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">tens</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span> <span class="mf">10.</span>
<span class="n">tens</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">tens</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tens</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">tens</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">samps</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">samps</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Data&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normalizing Flow Samples&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_{\alpha*}$ (mas/yr)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_{\delta}$ (mas/yr)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/e1f9320ef7f8358da37622d45d1a9a1eae23490b78789c64929b8c4ec2b35fd0.png" src="../_images/e1f9320ef7f8358da37622d45d1a9a1eae23490b78789c64929b8c4ec2b35fd0.png" />
</div>
</div>
<section id="density-estimation-with-the-flow">
<h3>Density Estimation with the Flow<a class="headerlink" href="#density-estimation-with-the-flow" title="Permalink to this headline">#</a></h3>
<p>While the flow defines a generative model, the goal of in this context is to have it as a density estimator, in which we want to</p>
<blockquote>
<div><p><strong>Estimate the log-probability of data points as a proxy for global density.</strong></p>
</div></blockquote>
<p>To do this, we may simply calculate the <code class="docutils literal notranslate"><span class="pre">log_prob</span></code> evaluated by the flow as the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logprobs</span> <span class="o">=</span> <span class="n">flow</span><span class="p">()</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">X_tensor</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">logRho</span><span class="p">,</span> <span class="n">logprobs</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;AstroLink Normalized $</span><span class="se">\\</span><span class="s1">log</span><span class="se">\\</span><span class="s1">rho$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flow Log Probability&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/2cbc9306cc7089ad7c5badd6b2d442196c717352b77411a0c31abeb4b83c1216.png" src="../_images/2cbc9306cc7089ad7c5badd6b2d442196c717352b77411a0c31abeb4b83c1216.png" />
</div>
</div>
<p>There is indeed a good correspondence between the density evaluated by <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> and the log probability of the flow! We therefore can expect that by setting log probability thresholds on a flow that models the data, we are able to reveal overdensities in the dataset.</p>
<p>To more concretely demonstrate this, let’s proceed with a fresh initialization of <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> over the <em>Gaia</em> dataset. In this particular line of code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">clusterer_new</span><span class="o">.</span><span class="n">logRho</span> <span class="o">=</span> <span class="n">logprobs</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logprobs</span><span class="p">)</span>      
</pre></div>
</div>
<p>We will be replacing the density estimated by <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> with the normalized log probability from the flow, scaled to the range of [0,1].</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Manually get kNN ##</span>
<span class="n">clusterer_new</span> <span class="o">=</span> <span class="n">AstroLink</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">clusterer_new</span><span class="o">.</span><span class="n">transform_data</span><span class="p">()</span>
<span class="n">clusterer_new</span><span class="o">.</span><span class="n">estimate_density_and_kNN</span><span class="p">()</span>
<span class="n">nearest_neighbours</span> <span class="o">=</span> <span class="n">clusterer_new</span><span class="o">.</span><span class="n">kNN</span>

<span class="n">clusterer_new</span><span class="o">.</span><span class="n">logRho</span> <span class="o">=</span> <span class="p">(</span><span class="n">logprobs</span> <span class="o">-</span> <span class="n">logprobs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">logprobs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">logprobs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="c1"># Substitute density</span>
<span class="n">clusterer_new</span><span class="o">.</span><span class="n">aggregate</span><span class="p">()</span> <span class="c1"># Calculate ordering using log probs</span>
<span class="n">clusterer_new</span><span class="o">.</span><span class="n">compute_significances</span><span class="p">()</span>
<span class="n">clusterer_new</span><span class="o">.</span><span class="n">extract_clusters</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">cluster_thresholds</span><span class="p">(</span><span class="n">clusterer_new</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3b809e93f3d8c08ddccdc3cb56359bee210590af3099af937db4f3cf8fba94a0.png" src="../_images/3b809e93f3d8c08ddccdc3cb56359bee210590af3099af937db4f3cf8fba94a0.png" />
</div>
</div>
</section>
</section>
<section id="clustering-stellar-streams">
<h2>Clustering Stellar Streams<a class="headerlink" href="#clustering-stellar-streams" title="Permalink to this headline">#</a></h2>
<p>The exquisite data from <em>Gaia</em> allows us to identify groups of stars thought to be accreted from outside the Milky Way, which typically happens early in our Galaxy’s own history. These stars are described as being <strong>phase mixed</strong>, meaning that they no longer clump together at a single position in velocity and space like star clusters, but have been tidally dispersed throughout the Milky Way potential.</p>
<p>However, these stars may still share similar dynamics, as they will continue to follow closely the trajectory of the system they used to belong to (e.g., dwarf galaxy). By clustering <strong>kinematic properties of their orbits</strong>, astronomers thus aim to find accreted groups of stars and build a picture of the Galaxy’s formation history.</p>
<p>Let’s examine the <em>Gaia</em> dataset from <a class="reference external" href="https://www.aanda.org/articles/aa/pdf/2023/02/aa44546-22.pdf">Dodd et al. (2022)</a>, which contains the following kinematic information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data_folder_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/stream.parquet&#39;</span><span class="p">);</span> <span class="n">stream</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lz</th>
      <th>Lperp</th>
      <th>En</th>
      <th>vR</th>
      <th>vphi</th>
      <th>vz</th>
      <th>labelOri</th>
      <th>GaiaDR3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992.978166</td>
      <td>170.537312</td>
      <td>-103341.621919</td>
      <td>-214.151461</td>
      <td>212.153457</td>
      <td>-20.237207</td>
      <td>-1</td>
      <td>3450980766068770304</td>
    </tr>
    <tr>
      <th>1</th>
      <td>62.965847</td>
      <td>32.347314</td>
      <td>-133908.214665</td>
      <td>67.586464</td>
      <td>69.553004</td>
      <td>5.685157</td>
      <td>-1</td>
      <td>3450869676738158848</td>
    </tr>
    <tr>
      <th>2</th>
      <td>768.603329</td>
      <td>100.716736</td>
      <td>-137623.940939</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1</td>
      <td>5918256954391665024</td>
    </tr>
    <tr>
      <th>3</th>
      <td>250.633749</td>
      <td>496.880744</td>
      <td>-141668.714915</td>
      <td>-71.932065</td>
      <td>57.485603</td>
      <td>-45.793720</td>
      <td>-1</td>
      <td>3829892917041332608</td>
    </tr>
    <tr>
      <th>4</th>
      <td>749.445831</td>
      <td>618.477728</td>
      <td>-148169.458172</td>
      <td>180.652753</td>
      <td>406.035578</td>
      <td>-525.860530</td>
      <td>-1</td>
      <td>4124284131794966656</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>193826</th>
      <td>50.750393</td>
      <td>83.053458</td>
      <td>-185307.388029</td>
      <td>-129.391454</td>
      <td>159.421807</td>
      <td>10.893195</td>
      <td>-1</td>
      <td>6029473247149249408</td>
    </tr>
    <tr>
      <th>193827</th>
      <td>-449.244641</td>
      <td>393.685482</td>
      <td>-153560.068276</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1</td>
      <td>5242677088572700160</td>
    </tr>
    <tr>
      <th>193828</th>
      <td>622.397081</td>
      <td>650.992679</td>
      <td>-143357.050733</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1</td>
      <td>4112018834700648576</td>
    </tr>
    <tr>
      <th>193829</th>
      <td>574.687362</td>
      <td>434.642499</td>
      <td>-155875.299936</td>
      <td>178.640887</td>
      <td>232.985835</td>
      <td>-79.046176</td>
      <td>-1</td>
      <td>4123954003445940864</td>
    </tr>
    <tr>
      <th>193830</th>
      <td>414.363562</td>
      <td>442.276465</td>
      <td>-137713.524569</td>
      <td>277.403929</td>
      <td>-28.778822</td>
      <td>71.956958</td>
      <td>-1</td>
      <td>5926965812361928832</td>
    </tr>
  </tbody>
</table>
<p>193831 rows × 8 columns</p>
</div></div></div>
</div>
<p>The above DataFrame has the following columns:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Column</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">GaiaDR3</span></code></p></td>
<td><p>Unique Gaia source identifier.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">labelOri</span></code></p></td>
<td><p>Cluster identification of stellar stream membership, with <code class="docutils literal notranslate"><span class="pre">-1</span></code> indicating no membership</p></td>
</tr>
<tr class="row-even"><td><p><strong><code class="docutils literal notranslate"><span class="pre">vR</span></code></strong> <span class="math notranslate nohighlight">\((v_R)\)</span></p></td>
<td><p>Radial velocity in the plane: motion toward or away from the Galactic center in units of km s<span class="math notranslate nohighlight">\(^{-1}\)</span>.</p></td>
</tr>
<tr class="row-odd"><td><p><strong><code class="docutils literal notranslate"><span class="pre">vphi</span></code></strong> <span class="math notranslate nohighlight">\((v_\phi)\)</span></p></td>
<td><p>Azimuthal (tangential) velocity around the Galactic center in units of km s<span class="math notranslate nohighlight">\(^{-1}\)</span>. Defined to be positive for prograde motion.</p></td>
</tr>
<tr class="row-even"><td><p><strong><code class="docutils literal notranslate"><span class="pre">vz</span></code></strong> <span class="math notranslate nohighlight">\((v_z)\)</span></p></td>
<td><p>Vertical velocity: motion above or below the Galactic plane in units of km s<span class="math notranslate nohighlight">\(^{-1}\)</span>.</p></td>
</tr>
<tr class="row-odd"><td><p><strong><code class="docutils literal notranslate"><span class="pre">Lz</span></code></strong> <span class="math notranslate nohighlight">\((L_z)\)</span></p></td>
<td><p>Specific angular momentum about the Galactic <span class="math notranslate nohighlight">\( z \)</span>-axis: <span class="math notranslate nohighlight">\( L_z = R \cdot v_\phi \)</span> in units of kpc km s<span class="math notranslate nohighlight">\(^{-1}\)</span>. Defined to be positive values for prograde orbits (same sense as Galactic rotation).</p></td>
</tr>
<tr class="row-even"><td><p><strong><code class="docutils literal notranslate"><span class="pre">Lperp</span></code></strong> <span class="math notranslate nohighlight">\((L_{\perp})\)</span></p></td>
<td><p>Magnitude of angular momentum perpendicular to <span class="math notranslate nohighlight">\( L_z \)</span> in in units of kpc km s<span class="math notranslate nohighlight">\(^{-1}\)</span>. Indicates how tilted the orbit is with respect to the Galactic plane.</p></td>
</tr>
<tr class="row-odd"><td><p><strong><code class="docutils literal notranslate"><span class="pre">En</span></code></strong> (<span class="math notranslate nohighlight">\(E\)</span>)</p></td>
<td><p>Specific orbital energy <span class="math notranslate nohighlight">\( E = \frac{1}{2}(v_R^2 + v_\phi^2 + v_z^2) + \Phi(R, z) \)</span>, dependent on the Milky Way potential <span class="math notranslate nohighlight">\( \Phi(R, z)\)</span>. Values presented in units of kpc km s<span class="math notranslate nohighlight">\(^{-1}\)</span>.</p></td>
</tr>
</tbody>
</table>
<div class="seealso admonition">
<p class="admonition-title">Cylindrical coordinate system</p>
<p>The cylindrical coordinate system, represented by quantities <span class="math notranslate nohighlight">\(R, \phi,\)</span> and <span class="math notranslate nohighlight">\(z\)</span> (see schematic below) provides a natural framework for describing stellar motion relative to the Milky Way disk. It is particularly well-suited for analyzing dynamics in a rotating, disk-like system, such as motion with respect to Galactic rotation.</p>
<figure class="align-default" id="cylindrical">
<a class="reference internal image-reference" href="../_images/cylindrical.png"><img alt="../_images/cylindrical.png" src="../_images/cylindrical.png" style="width: 500px; height: 370px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 37 </span><span class="caption-text">Cylindrical polar coordinates <span class="math notranslate nohighlight">\(R, \phi, z\)</span> with the origin at the Galactic Center (GC). Image from <a class="reference external" href="https://www.cambridge.org/highereducation/books/galaxies-in-the-universe/905351A922D65FCD8D27EA38AB4BB5BE">Sparke and Gallagher (2007).</a></span><a class="headerlink" href="#cylindrical" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div>
<section id="clustering-in-velocity-space">
<h3>Clustering in Velocity Space<a class="headerlink" href="#clustering-in-velocity-space" title="Permalink to this headline">#</a></h3>
<p>A view commonly used to find co-moving groups of stars is in <strong>velocity space</strong>, shown as the following:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">vR</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">vphi</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">vR</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">vz</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">vz</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">vphi</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">600</span><span class="p">,</span> <span class="mi">610</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">550</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">450</span><span class="p">,</span> <span class="mi">450</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">450</span><span class="p">,</span> <span class="mi">600</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">450</span><span class="p">,</span> <span class="mi">450</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">450</span><span class="p">,</span> <span class="mi">600</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$v_R$ (km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$v_R$ (km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$v_z$ (km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$v_{\phi}$ (km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$v_z$ (km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$v_{\phi}$ (km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/9f4bdffbc70cc5f4c1163ebc02acc6ac28893a33c6a9680118dfc711ea1558d2.png" src="../_images/9f4bdffbc70cc5f4c1163ebc02acc6ac28893a33c6a9680118dfc711ea1558d2.png" />
</div>
</div>
<p>To date, multiple kinematic substructures have been discovered around the Milky Way, whose presence in velocity space can be seen below:</p>
<figure class="align-default" id="stream-vel">
<a class="reference internal image-reference" href="../_images/stream_vel.png"><img alt="../_images/stream_vel.png" src="../_images/stream_vel.png" style="width: 800px; height: 250px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 38 </span><span class="caption-text">The presence of known stellar streams in velocity space. Image adopted from Fig. 3 of <a class="reference external" href="https://www.aanda.org/articles/aa/pdf/2023/02/aa44546-22.pdf">Dodd et al. (2022)</a>.</span><a class="headerlink" href="#stream-vel" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="note admonition">
<p class="admonition-title">Exercise: Clustering in Velocity Space</p>
<p>Perform clustering using <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> using <code class="docutils literal notranslate"><span class="pre">vR</span></code>, <code class="docutils literal notranslate"><span class="pre">vphi</span></code>, and <code class="docutils literal notranslate"><span class="pre">vz</span></code>. How many of the known stellar streams in the above Figure can be recovered?</p>
</div>
</section>
<section id="clustering-in-integral-of-motion-iom-space">
<h3>Clustering in Integral of Motion (IoM) Space<a class="headerlink" href="#clustering-in-integral-of-motion-iom-space" title="Permalink to this headline">#</a></h3>
<p>Integrals of Motion are quantities that remain constant along an orbit in a time-independent gravitational potential. Unlike velocity space, which captures a star’s instantaneous motion, IoMs provide long-term invariants of orbital dynamics and can identify coherent structures that have phase-mixed in velocity but remain clustered in conserved quantities.</p>
<p>Commonly used IoMs to find stellar streams are angular momenta (<span class="math notranslate nohighlight">\(L_z\)</span>, <span class="math notranslate nohighlight">\(L_{\perp}\)</span>) and total energy <span class="math notranslate nohighlight">\(E\)</span>:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">Lz</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">En</span><span class="o">/</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">Lz</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">Lperp</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">Lperp</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">En</span><span class="o">/</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="c1"># ax1.set_xlim([-600, 610])</span>
<span class="c1"># ax2.set_xlim([-500, 550])</span>
<span class="c1"># ax3.set_xlim([-450, 450])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.9</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="c1"># ax2.set_ylim([-450, 450])</span>
<span class="c1"># ax3.set_ylim([-450, 600])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$L_z$ ($10^3$ kpc km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$L_z$ ($10^3$ kpc km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$L_{\perp}$ ($10^5$ kpc km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$E$ ($10^5$ kpc km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$L_{\perp}$ ($10^3$ kpc km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$E$ ($10^5$ kpc km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/67975774a13f0b2c6dda3f35259624175e241cf648f27bee2331a7251dc963e5.png" src="../_images/67975774a13f0b2c6dda3f35259624175e241cf648f27bee2331a7251dc963e5.png" />
</div>
</div>
<p>Known kinematic substructures around the Solar neighbourhood manifest are expected to manifest as overdensities in IoM space. The following figure shows their presence in IoM space.</p>
<figure class="align-default" id="stream-action">
<a class="reference internal image-reference" href="../_images/stream_action.png"><img alt="../_images/stream_action.png" src="../_images/stream_action.png" style="width: 800px; height: 250px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 39 </span><span class="caption-text">The presence of known stellar streams in Integral-of-Motion (IoM) space. Image adopted from Fig. 3 of <a class="reference external" href="https://www.aanda.org/articles/aa/pdf/2023/02/aa44546-22.pdf">Dodd et al. (2022)</a>.</span><a class="headerlink" href="#stream-action" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="note admonition">
<p class="admonition-title">Exercise: Clustering in IoM Space</p>
<p>Perform clustering using <code class="docutils literal notranslate"><span class="pre">AstroLink</span></code> using <code class="docutils literal notranslate"><span class="pre">Lz</span></code>, <code class="docutils literal notranslate"><span class="pre">Lperp</span></code>, and <code class="docutils literal notranslate"><span class="pre">En</span></code>. How many of the known stellar streams can we now recover, compared to using velocity space information only?</p>
<p>Do we obtain more clusters if the clustering is performed using <strong>both</strong> velocity and IoM information?</p>
</div>
</section>
</section>
<section id="see-also">
<h2>See also<a class="headerlink" href="#see-also" title="Permalink to this headline">#</a></h2>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020ARA&amp;A..58..205H/abstract">Streams, Substructures, and the Early History of the Milky Way</a>, Amina Helmi, Annu. Rev. Astron. Astrophys. 2020. 58:205–56</p>
<!-- Train flows? -->
<!-- Include Gala orbits and comment on them? --></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapter3"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tabular-3.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Catalogue Data Part 1: <em>Mixed Data Types</em></p>
      </div>
    </a>
    <a class="right-next"
       href="tabular-5.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><em>The Physics Informed Neural Network</em></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#star-clusters">Star Clusters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-overdensities">Clustering Overdensities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-aggregation-process">The Aggregation Process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#connection-with-neural-density-estimation">Connection with Neural Density Estimation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#density-estimation-with-the-flow">Density Estimation with the Flow</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-stellar-streams">Clustering Stellar Streams</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-in-velocity-space">Clustering in Velocity Space</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-in-integral-of-motion-iom-space">Clustering in Integral of Motion (IoM) Space</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#see-also">See also</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Marc Hon
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>